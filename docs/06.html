<!DOCTYPE html>

<html lang="en">

<head>

<meta charset="UTF-8">

<meta http-equiv="X-UA-Compatible" content="IE=edge">

<meta name="viewport" content="width=device-width, initial-scale=1.0">

<meta name="generator" content="Asciidoctor 2.0.16">

<title>Part 5. How to Set Up Continuous Integration (CI) and Continuous Delivery (CD)</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">

<style>

/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */

/* Uncomment the following line when using as a custom stylesheet */

/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */

html{font-family:sans-serif;-webkit-text-size-adjust:100%}

a{background:none}

a:focus{outline:thin dotted}

a:active,a:hover{outline:0}

h1{font-size:2em;margin:.67em 0}

b,strong{font-weight:bold}

abbr{font-size:.9em}

abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}

dfn{font-style:italic}

hr{height:0}

mark{background:#ff0;color:#000}

code,kbd,pre,samp{font-family:monospace;font-size:1em}

pre{white-space:pre-wrap}

q{quotes:"\201C" "\201D" "\2018" "\2019"}

small{font-size:80%}

sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}

sup{top:-.5em}

sub{bottom:-.25em}

img{border:0}

svg:not(:root){overflow:hidden}

figure{margin:0}

audio,video{display:inline-block}

audio:not([controls]){display:none;height:0}

fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}

legend{border:0;padding:0}

button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}

button,input{line-height:normal}

button,select{text-transform:none}

button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}

button[disabled],html input[disabled]{cursor:default}

input[type=checkbox],input[type=radio]{padding:0}

button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}

textarea{overflow:auto;vertical-align:top}

table{border-collapse:collapse;border-spacing:0}

*,::before,::after{box-sizing:border-box}

html,body{font-size:100%}

body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}

a:hover{cursor:pointer}

img,object,embed{max-width:100%;height:auto}

object,embed{height:100%}

img{-ms-interpolation-mode:bicubic}

.left{float:left!important}

.right{float:right!important}

.text-left{text-align:left!important}

.text-right{text-align:right!important}

.text-center{text-align:center!important}

.text-justify{text-align:justify!important}

.hide{display:none}

img,object,svg{display:inline-block;vertical-align:middle}

textarea{height:auto;min-height:50px}

select{width:100%}

.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}

div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}

a{color:#2156a5;text-decoration:underline;line-height:inherit}

a:hover,a:focus{color:#1d4b8f}

a img{border:0}

p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}

p aside{font-size:.875em;line-height:1.35;font-style:italic}

h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}

h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}

h1{font-size:2.125em}

h2{font-size:1.6875em}

h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}

h4,h5{font-size:1.125em}

h6{font-size:1em}

hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}

em,i{font-style:italic;line-height:inherit}

strong,b{font-weight:bold;line-height:inherit}

small{font-size:60%;line-height:inherit}

code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}

ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}

ul,ol{margin-left:1.5em}

ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}

ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}

ul.square{list-style-type:square}

ul.circle{list-style-type:circle}

ul.disc{list-style-type:disc}

ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}

dl dt{margin-bottom:.3125em;font-weight:bold}

dl dd{margin-bottom:1.25em}

blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}

blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}

@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}

h1{font-size:2.75em}

h2{font-size:2.3125em}

h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}

h4{font-size:1.4375em}}

table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}

table thead,table tfoot{background:#f7f8f7}

table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}

table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}

table tr.even,table tr.alt{background:#f8f8f7}

table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}

h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}

h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}

.center{margin-left:auto;margin-right:auto}

.stretch{width:100%}

.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}

.clearfix::after,.float-group::after{clear:both}

:not(pre).nobreak{word-wrap:normal}

:not(pre).nowrap{white-space:nowrap}

:not(pre).pre-wrap{white-space:pre-wrap}

:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}

pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}

pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}

pre>code{display:block}

pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}

em em{font-style:normal}

strong strong{font-weight:400}

.keyseq{color:rgba(51,51,51,.8)}

kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}

.keyseq kbd:first-child{margin-left:0}

.keyseq kbd:last-child{margin-right:0}

.menuseq,.menuref{color:#000}

.menuseq b:not(.caret),.menuref{font-weight:inherit}

.menuseq{word-spacing:-.02em}

.menuseq b.caret{font-size:1.25em;line-height:.8}

.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}

b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}

b.button::before{content:"[";padding:0 3px 0 2px}

b.button::after{content:"]";padding:0 2px 0 3px}

p a>code:hover{color:rgba(0,0,0,.9)}

#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}

#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}

#header::after,#content::after,#footnotes::after,#footer::after{clear:both}

#content{margin-top:1.25em}

#content::before{content:none}

#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}

#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}

#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}

#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}

#header .details span:first-child{margin-left:-.125em}

#header .details span.email a{color:rgba(0,0,0,.85)}

#header .details br{display:none}

#header .details br+span::before{content:"\00a0\2013\00a0"}

#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}

#header .details br+span#revremark::before{content:"\00a0|\00a0"}

#header #revnumber{text-transform:capitalize}

#header #revnumber::after{content:"\00a0"}

#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}

#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}

#toc>ul{margin-left:.125em}

#toc ul.sectlevel0>li>a{font-style:italic}

#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}

#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}

#toc li{line-height:1.3334;margin-top:.3334em}

#toc a{text-decoration:none}

#toc a:active{text-decoration:underline}

#toctitle{color:#7a2518;font-size:1.2em}

@media screen and (min-width:768px){#toctitle{font-size:1.375em}

body.toc2{padding-left:15em;padding-right:0}

#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}

#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}

#toc.toc2>ul{font-size:.9em;margin-bottom:0}

#toc.toc2 ul ul{margin-left:0;padding-left:1em}

#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}

body.toc2.toc-right{padding-left:0;padding-right:15em}

body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}

@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}

#toc.toc2{width:20em}

#toc.toc2 #toctitle{font-size:1.375em}

#toc.toc2>ul{font-size:.95em}

#toc.toc2 ul ul{padding-left:1.25em}

body.toc2.toc-right{padding-left:0;padding-right:20em}}

#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}

#content #toc>:first-child{margin-top:0}

#content #toc>:last-child{margin-bottom:0}

#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}

#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}

#content{margin-bottom:.625em}

.sect1{padding-bottom:.625em}

@media screen and (min-width:768px){#content{margin-bottom:1.25em}

.sect1{padding-bottom:1.25em}}

.sect1:last-child{padding-bottom:0}

.sect1+.sect1{border-top:1px solid #e7e7e9}

#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}

#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}

#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}

#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}

#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}

details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}

details{margin-left:1.25rem}

details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;-webkit-tap-highlight-color:transparent}

details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}

details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}

details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}

.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}

table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}

.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}

.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}

.admonitionblock>table td.icon{text-align:center;width:80px}

.admonitionblock>table td.icon img{max-width:none}

.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}

.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}

.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}

.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}

.exampleblock>.content>:first-child{margin-top:0}

.exampleblock>.content>:last-child{margin-bottom:0}

.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}

.sidebarblock>:first-child{margin-top:0}

.sidebarblock>:last-child{margin-bottom:0}

.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}

.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}

.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}

@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}

@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}

.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}

.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}

.listingblock>.content{position:relative}

.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}

.listingblock:hover code[data-lang]::before{display:block}

.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}

.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}

.listingblock pre.highlightjs{padding:0}

.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}

.listingblock pre.prettyprint{border-width:0}

.prettyprint{background:#f7f7f8}

pre.prettyprint .linenums{line-height:1.45;margin-left:2em}

pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}

pre.prettyprint li code[data-lang]::before{opacity:1}

pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}

table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}

table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}

table.linenotable td.code{padding-left:.75em}

table.linenotable td.linenos{border-right:1px solid;opacity:.35;padding-right:.5em}

pre.pygments .lineno{border-right:1px solid;opacity:.35;display:inline-block;margin-right:.75em}

pre.pygments .lineno::before{content:"";margin-right:-.125em}

.quoteblock{margin:0 1em 1.25em 1.5em;display:table}

.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}

.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}

.quoteblock blockquote{margin:0;padding:0;border:0}

.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}

.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}

.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}

.verseblock{margin:0 1em 1.25em}

.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}

.verseblock pre strong{font-weight:400}

.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}

.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}

.quoteblock .attribution br,.verseblock .attribution br{display:none}

.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}

.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}

.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}

.quoteblock.abstract{margin:0 1em 1.25em;display:block}

.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}

.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}

.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}

.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}

.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}

p.tableblock:last-child{margin-bottom:0}

td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}

td.tableblock>.content>:last-child{margin-bottom:-1.25em}

table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}

table.grid-all>*>tr>*{border-width:1px}

table.grid-cols>*>tr>*{border-width:0 1px}

table.grid-rows>*>tr>*{border-width:1px 0}

table.frame-all{border-width:1px}

table.frame-ends{border-width:1px 0}

table.frame-sides{border-width:0 1px}

table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}

table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}

table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}

table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}

table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd),table.stripes-even tr:nth-of-type(even),table.stripes-hover tr:hover{background:#f8f8f7}

th.halign-left,td.halign-left{text-align:left}

th.halign-right,td.halign-right{text-align:right}

th.halign-center,td.halign-center{text-align:center}

th.valign-top,td.valign-top{vertical-align:top}

th.valign-bottom,td.valign-bottom{vertical-align:bottom}

th.valign-middle,td.valign-middle{vertical-align:middle}

table thead th,table tfoot th{font-weight:bold}

tbody tr th{background:#f7f8f7}

tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}

p.tableblock>code:only-child{background:none;padding:0}

p.tableblock{font-size:1em}

ol{margin-left:1.75em}

ul li ol{margin-left:1.5em}

dl dd{margin-left:1.125em}

dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}

ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}

ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}

ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}

ul.unstyled,ol.unstyled{margin-left:0}

ul.checklist>li>p:first-child{margin-left:-1em}

ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}

ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}

ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}

ul.inline>li{margin-left:1.25em}

.unstyled dl dt{font-weight:400;font-style:normal}

ol.arabic{list-style-type:decimal}

ol.decimal{list-style-type:decimal-leading-zero}

ol.loweralpha{list-style-type:lower-alpha}

ol.upperalpha{list-style-type:upper-alpha}

ol.lowerroman{list-style-type:lower-roman}

ol.upperroman{list-style-type:upper-roman}

ol.lowergreek{list-style-type:lower-greek}

.hdlist>table,.colist>table{border:0;background:none}

.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}

td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}

td.hdlist1{font-weight:bold;padding-bottom:1.25em}

td.hdlist2{word-wrap:anywhere}

.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}

.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}

.colist td:not([class]):first-child img{max-width:none}

.colist td:not([class]):last-child{padding:.25em 0}

.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}

.imageblock.left{margin:.25em .625em 1.25em 0}

.imageblock.right{margin:.25em 0 1.25em .625em}

.imageblock>.title{margin-bottom:0}

.imageblock.thumb,.imageblock.th{border-width:6px}

.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}

.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}

.image.left{margin-right:.625em}

.image.right{margin-left:.625em}

a.image{text-decoration:none;display:inline-block}

a.image object{pointer-events:none}

sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}

sup.footnote a,sup.footnoteref a{text-decoration:none}

sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}

#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}

#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}

#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}

#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}

#footnotes .footnote:last-of-type{margin-bottom:0}

#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}

.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}

.gist .file-data>table td.line-data{width:99%}

div.unbreakable{page-break-inside:avoid}

.big{font-size:larger}

.small{font-size:smaller}

.underline{text-decoration:underline}

.overline{text-decoration:overline}

.line-through{text-decoration:line-through}

.aqua{color:#00bfbf}

.aqua-background{background:#00fafa}

.black{color:#000}

.black-background{background:#000}

.blue{color:#0000bf}

.blue-background{background:#0000fa}

.fuchsia{color:#bf00bf}

.fuchsia-background{background:#fa00fa}

.gray{color:#606060}

.gray-background{background:#7d7d7d}

.green{color:#006000}

.green-background{background:#007d00}

.lime{color:#00bf00}

.lime-background{background:#00fa00}

.maroon{color:#600000}

.maroon-background{background:#7d0000}

.navy{color:#000060}

.navy-background{background:#00007d}

.olive{color:#606000}

.olive-background{background:#7d7d00}

.purple{color:#600060}

.purple-background{background:#7d007d}

.red{color:#bf0000}

.red-background{background:#fa0000}

.silver{color:#909090}

.silver-background{background:#bcbcbc}

.teal{color:#006060}

.teal-background{background:#007d7d}

.white{color:#bfbfbf}

.white-background{background:#fafafa}

.yellow{color:#bfbf00}

.yellow-background{background:#fafa00}

span.icon>.fa{cursor:default}

a span.icon>.fa{cursor:inherit}

.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}

.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}

.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}

.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}

.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}

.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}

.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}

.conum[data-value] *{color:#fff!important}

.conum[data-value]+b{display:none}

.conum[data-value]::after{content:attr(data-value)}

pre .conum[data-value]{position:relative;top:-.125em}

b.conum *{color:inherit!important}

.conum:not([data-value]):empty{display:none}

dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}

h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}

p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}

p,blockquote,dt,td.content,span.alt,summary{font-size:1.0625rem}

p{margin-bottom:1.25rem}

.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}

.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}

.print-only{display:none!important}

@page{margin:1.25cm .75cm}

@media print{*{box-shadow:none!important;text-shadow:none!important}

html{font-size:80%}

a{color:inherit!important;text-decoration:underline!important}

a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}

a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}

abbr[title]{border-bottom:1px dotted}

abbr[title]::after{content:" (" attr(title) ")"}

pre,blockquote,tr,img,object,svg{page-break-inside:avoid}

thead{display:table-header-group}

svg{max-width:100%}

p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}

h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}

#header,#content,#footnotes,#footer{max-width:none}

#toc,.sidebarblock,.exampleblock>.content{background:none!important}

#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}

body.book #header{text-align:center}

body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}

body.book #header .details{border:0!important;display:block;padding:0!important}

body.book #header .details span:first-child{margin-left:0!important}

body.book #header .details br{display:block}

body.book #header .details br+span::before{content:none!important}

body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}

body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}

.listingblock code[data-lang]::before{display:block}

#footer{padding:0 .9375em}

.hide-on-print{display:none!important}

.print-only{display:block!important}

.hide-for-print{display:none!important}

.show-for-print{display:inherit!important}}

@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}

.sect1{padding:0!important}

.sect1+.sect1{border:0}

#footer{background:none}

#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}

@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}

</style>


<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

<style>
h1 {
    margin-bottom: 50px;
}
h2 {
    margin-top: 50px;
    margin-bottom: 10px;
}
h3 {
    margin-top: 30px;
    margin-bottom: 10px;
}
h4 {
    margin-top: 20px;
    margin-bottom: 10px;
}

pre {
    line-height: 12px !important;
    font-size: 14px !important;
    margin-bottom: 0 !important;
}

#toc-dynamic>ul {
    margin: 0;
}

table ul {
    margin-left: 0;
    padding-left: 15px;
}
</style>

</head>

<body class="book" data-bs-spy="scroll" data-bs-target="#toc-dynamic" data-bs-smooth-scroll="true" tabindex="0">

<div class="container">
  <div class="row">
    <div class="col-sm-4">
      <nav id="toc-dynamic" class="sticky-top vh-100" style="overflow: scroll; padding-top: 25px; padding-bottom: 25px;">
          <a href="index.html" class="h6 text-decoration-none">Fundamentals of DevOps and Software Delivery</a>
          <ul class="nav nav-pills flex-column"><li class="nav-item"><a href="#how_to_set_up_ci_cd" class="nav-link">5. How to Set Up Continuous Integration (CI) and Continuous Delivery (CD)</a>
</li>

<li class="nav-item"><a href="#_continuous_integration_ci" class="nav-link">5.1. Continuous Integration (CI)</a>

<ul class="nav nav-pills flex-column">

<li class="nav-item"><a href="#_dealing_with_merge_conflicts" class="nav-link">5.1.1. Dealing with merge conflicts</a></li>

<li class="nav-item"><a href="#_preventing_breakages_with_self_testing_builds" class="nav-link">5.1.2. Preventing breakages with self-testing builds</a></li>

<li class="nav-item"><a href="#_making_large_changes" class="nav-link">5.1.3. Making large changes</a>

<ul class="nav nav-pills flex-column">

<li class="nav-item"><a href="#branch_by_abstraction" class="nav-link">Branch by abstraction</a></li>

<li class="nav-item"><a href="#feature_toggles" class="nav-link">Feature toggles</a></li>

</ul>

</li>

<li class="nav-item"><a href="#_example_set_up_automated_tests_for_your_app_code_with_github_actions" class="nav-link">5.1.4. Example: set up automated tests for your app code with GitHub Actions</a></li>

<li class="nav-item"><a href="#_machine_user_credentials_and_automatically_provisioned_credentials" class="nav-link">5.1.5. Machine user credentials and automatically-provisioned credentials</a>

<ul class="nav nav-pills flex-column">

<li class="nav-item"><a href="#_machine_user_credentials" class="nav-link">Machine user credentials</a></li>

<li class="nav-item"><a href="#_automatically_provisioned_credentials" class="nav-link">Automatically-provisioned credentials</a></li>

</ul>

</li>

<li class="nav-item"><a href="#_example_configure_oidc_for_use_with_automated_tests_in_github_actions" class="nav-link">5.1.6. Example: configure OIDC for use with automated tests in GitHub Actions</a></li>

<li class="nav-item"><a href="#_example_set_up_automated_tests_for_infrastructure_code_with_github_actions" class="nav-link">5.1.7. Example: set up automated tests for infrastructure code with GitHub Actions</a></li>

</ul>

</li>

<li class="nav-item"><a href="#_continuous_delivery_cd" class="nav-link">5.2. Continuous Delivery (CD)</a>

<ul class="nav nav-pills flex-column">

<li class="nav-item"><a href="#_deployment_strategies" class="nav-link">5.2.1. Deployment strategies</a>

<ul class="nav nav-pills flex-column">

<li class="nav-item"><a href="#_downtime_deployment" class="nav-link">Downtime deployment</a></li>

<li class="nav-item"><a href="#_rolling_deployment_without_replacement" class="nav-link">Rolling deployment without replacement</a></li>

<li class="nav-item"><a href="#_rolling_deployment_with_replacement" class="nav-link">Rolling deployment with replacement</a></li>

<li class="nav-item"><a href="#_blue_green_deployment" class="nav-link">Blue-green deployment</a></li>

<li class="nav-item"><a href="#_canary_deployment" class="nav-link">Canary deployment</a></li>

<li class="nav-item"><a href="#_feature_toggle_deployment" class="nav-link">Feature toggle deployment</a></li>

<li class="nav-item"><a href="#_promotion_deployment" class="nav-link">Promotion deployment</a></li>

<li class="nav-item"><a href="#_infrastructure_deployment" class="nav-link">Infrastructure deployment</a></li>

</ul>

</li>

<li class="nav-item"><a href="#_deployment_pipelines" class="nav-link">5.2.2. Deployment pipelines</a>

<ul class="nav nav-pills flex-column">

<li class="nav-item"><a href="#_example_configure_an_automated_deployment_pipeline_in_github_actions" class="nav-link">Example: configure an automated deployment pipeline in GitHub Actions</a></li>

<li class="nav-item"><a href="#_example_use_a_remote_backend_for_opentofu_state" class="nav-link">Example: use a remote backend for OpenTofu state</a></li>

<li class="nav-item"><a href="#_example_add_iam_roles_for_infrastructure_deployments_in_github_actions" class="nav-link">Example: add IAM roles for infrastructure deployments in GitHub Actions</a></li>

<li class="nav-item"><a href="#_example_define_a_pipeline_for_infrastructure_deployments" class="nav-link">Example: define a pipeline for infrastructure deployments</a></li>

<li class="nav-item"><a href="#_deployment_pipeline_best_practices" class="nav-link">Deployment pipeline best practices</a></li>

</ul>

</li>

</ul>

</li>

<li class="nav-item"><a href="#_conclusion_5" class="nav-link">5.3. Conclusion</a></li>

</ul>

      </nav>
    </div>
    <div class="col-sm-8">

<div id="content">
<div class="sect1">

<h1 id="how_to_set_up_ci_cd">Part 5. How to Set Up Continuous Integration (CI) and Continuous Delivery (CD)</h1>

<div class="sectionbody">

<div class="paragraph">

<p>In <a href="05.html#how_to_version_build_test">Part 4</a>, you learned several key tools and techniques that help developers work together,

including version control, build systems, and automated tests. But merely having a collection of tools and

techniques is not enough: you also need to know how to put them together into an effective software delivery lifecycle

(SDLC). As a reminder, the SDLC needs to solve the following problems:</p>

</div>

<div class="dlist">

<dl>

<dt class="hdlist1">Code access</dt>

<dd>

<p>All the developers on your team need a way to access the same code so they can all collaborate on it.</p>

</dd>

<dt class="hdlist1">Integration</dt>

<dd>

<p>As multiple developers make changes to the same code base, you need some way to <em>integrate</em> their

changes, handling any conflicts that arise, and ensuring that no one&#8217;s work is accidentally lost or overwritten.</p>

</dd>

<dt class="hdlist1">Correctness</dt>

<dd>

<p>It&#8217;s hard enough to make your own code work, but when multiple people are modifying that code at

the same time, you need to find a way to prevent constant bugs and breakages from slipping in.</p>

</dd>

<dt class="hdlist1">Release</dt>

<dd>

<p>Getting a codebase working is great, but as you may remember from the <a href="index.html#preface">Introduction</a>, code isn&#8217;t done until

it&#8217;s generating value for your users and your company, which means you need a way to <em>release</em> the changes in your

codebase on a periodic basis.</p>

</dd>

</dl>

</div>

<div class="paragraph">

<p>Now that you have the ingredients for solving these problems, in this blog post, you&#8217;ll learn how to

put these ingredients together. To do this, you will first learn about continuous integration (CI) and then continuous

delivery (CD). The combination of the two, CI/CD, is a central part of the SDLC of all the companies you read about in

<a href="index.html#world_class_delivery">What world-class software delivery looks like</a> that have world-class software delivery practices.</p>

</div>

<div class="paragraph">

<p>Let&#8217;s start with CI.</p>

</div>

<div class="sect2">

<h2 id="_continuous_integration_ci">Continuous Integration (CI)</h2>

<div class="paragraph">

<p>What is continuous integration? It may be easier to understand it by comparing it with its opposite, <em>late integration</em>.</p>

</div>

<div class="paragraph">

<p>Imagine you&#8217;re responsible for building the International Space Station (ISS), which consists of dozens of components,

as shown in <a href="06.html#iss">Figure 39</a>.</p>

</div>

<div id="iss" class="imageblock">

<div class="content">

<img src="images/ch5/iss.png" alt="International Space Station">

</div>

<div class="title">Figure 39. International Space Station <sup class="footnote">[<a id="_footnoteref_34" class="footnote" href="13-footnotes.html#_footnotedef_34" title="View footnote.">34</a>]</sup></div>

</div>

<div class="paragraph">

<p>Each component will be assigned to a team from a different country, and it&#8217;s up to you to decide how you will organize

these teams. You have two options:</p>

</div>

<div class="dlist">

<dl>

<dt class="hdlist1">Option 1: late integration</dt>

<dd>

<p>Come up with a design for all the components up front and then have each team go off

and work on their component in complete isolation until it&#8217;s finished. When all the teams are done, launch all the

components into outer space, and try to put them together at the same time.</p>

</dd>

<dt class="hdlist1">Option 2: continuous integration</dt>

<dd>

<p>Come up with an initial design for all the components and then have each team go

off and start working. As they make progress, they regularly test each component with all the other components and

update the design if there are any problems. As components are completed, you launch them one at a time into outer

space, and assemble them incrementally.</p>

</dd>

</dl>

</div>

<div class="paragraph">

<p>How do you think option #1 is going to work out? In all likelihood, attempting to assemble the entire ISS at the last

minute will expose a vast number of conflicts and design problems. Team A thought team B would handle the wiring while

team B thought team A would do it; all the teams used the metric system, except one; no one remembered to install a

toilet. Unfortunately, as everything has been fully built and is already floating in outer space, it will be expensive

and difficult to go back and fix things.</p>

</div>

<div class="paragraph">

<p>Option 1 may sound ridiculous, but this is exactly the way in which many companies build software. Developers

work in totally isolated <em>feature branches</em> in their version control system for weeks or months at a time and then, at

the very last minute, when a release rolls around, they try to merge all the feature branches together. This process is

known as <em>late integration</em>, and it often leads to disaster, as shown in <a href="06.html#late_integration">Figure 40</a>.</p>

</div>

<div id="late_integration" class="imageblock">

<div class="content">

<img src="images/ch5/late-integration.png" alt="The huge merge conflicts that you get as a result of late integration">

</div>

<div class="title">Figure 40. The huge merge conflicts that you get as a result of late integration</div>

</div>

<div class="paragraph">

<p>When you don&#8217;t merge your code together for long periods of time, you end up with horrible merge conflicts: two teams

modified the same file, but in incompatible ways; one team has made changes in a file that another team deleted

entirely; one team did a giant refactor to remove all usages of a deprecated service, but the other teams have

introduced dozens of new usages of that service; and so on. All of these conflicts lead to bugs and problems that take

days or weeks to stabilize, turning the release process into a long, drawn-out nightmare.</p>

</div>

<div class="paragraph">

<p>A better approach, as described in option #2, is <em>continuous integration (CI)</em>, which is software development practice

with the following key property:</p>

</div>

<div class="admonitionblock tip">

<table>

<tr>

<td class="icon">

<div class="title">Tip</div>

</td>

<td class="content">

<div class="title">Key takeaway #1</div>

<div class="paragraph">

<p>All developers merge all their work together on a regular basis: typically daily or multiple times per day.</p>

</div>

</td>

</tr>

</table>

</div>

<div class="paragraph">

<p>The key benefit of CI is that it exposes problems with your work earlier in the process, before you&#8217;ve

gone too far in the wrong direction, and allows you to make improvements incrementally.</p>

</div>

<div class="paragraph">

<p>The most common way to implement continuous integration is to use a <em>trunk-based development model</em>, where developers

do all of their work on the same branch, typically <code>main</code> or <code>master</code> or <code>trunk</code>, depending on what

your VCS calls it; I&#8217;ll mostly refer to this branch as <code>main</code> in this blog post series. With trunk-based development,

you no longer have long-lived feature branches. Instead, you create short-lived branches, that typically last from a

few hours to a few days, and you open pull requests to get your branch merged back into <code>main</code> on a regular basis.</p>

</div>

<div class="paragraph">

<p>It may seem like having all developers work on a single branch couldn&#8217;t possibly scale, but the reality is

that it might be the only way to scale. LinkedIn moved off of feature branches and onto trunk-based development as

part of Project Inversion, which was essential for scaling the company from roughly 100 developers to over 1,000.

Facebook uses trunk-based development for thousands of

developers.<sup class="footnote">[<a id="_footnoteref_35" class="footnote" href="13-footnotes.html#_footnotedef_35" title="View footnote.">35</a>]</sup> Google uses

trunk-based development for tens of thousands of developers, and has shown it can scale to 2+ billion lines of code,

86TB of source data, and around 40,000 commits per

day.<sup class="footnote">[<a id="_footnoteref_36" class="footnote" href="13-footnotes.html#_footnotedef_36" title="View footnote.">36</a>]</sup></p>

</div>

<div class="paragraph">

<p>If you&#8217;ve never used trunk-based development, it can be hard to imagine how it works. The same questions come up again

and again:</p>

</div>

<div class="ulist">

<ul>

<li>

<p>Wouldn&#8217;t you have merge conflicts all the time?</p>

</li>

<li>

<p>Wouldn&#8217;t the build always be broken?</p>

</li>

<li>

<p>How do you make large changes that take weeks or months?</p>

</li>

</ul>

</div>

<div class="paragraph">

<p>In the next three sections, I&#8217;ll address each of these questions, showing the tools and techniques companies use to

deal with them, and then walk you through an example of how to set up some of these continuous integration tools and

techniques yourself.</p>

</div>

<div class="sect3">

<h3 id="_dealing_with_merge_conflicts">Dealing with merge conflicts</h3>

<div class="paragraph">

<p>The first question that newbies to trunk-based development often ask is, won&#8217;t you be dealing with merge conflicts

all the time? After all, with feature branches, each time you merge, you get days or weeks of conflicts to resolve,

but at least you only have to deal with that once every few weeks or months. Whereas with trunk-based development,

wouldn&#8217;t you have to fight with merge conflicts many times per day?</p>

</div>

<div class="paragraph">

<p>As it turns out, the reason that feature branches lead to painful merge conflicts is precisely because those feature

branches are long-lived. If your branches are short-lived, the odds of merge conflicts are much lower. For example,

imagine you have a repo with 10,000 files, and two developers working on changes in different branches. After one day,

perhaps each developer has changed 10 files; if they try to merge the branches back together, the chances that some

of those 20 files overlap, out of 10,000, are pretty low. But if those developers worked in those branches for three

months, and changed hundreds of files in each branch during that time, then the chances that some of those files

overlap and conflict are much higher.</p>

</div>

<div class="paragraph">

<p>Moreover, even if there are a merge conflicts, it&#8217;s much easier to deal with them if you merge regularly. If you&#8217;re

merging two branches that are just a day old, the conflicts will be relatively small, as you can&#8217;t change all that much

code in just a few days, and the code will still be top-of-mind, as worked on it within the last 24 hours. On the other

hand, if you&#8217;re merging code that is several months old, then the conflicts will be larger, as you can make a lot of

changes in a few months, and you&#8217;re less likely to remember what the changes are about, as you may have worked on them

months ago.</p>

</div>

<div class="paragraph">

<p>The most important thing to understand is this: When you have multiple developers working on a single codebase at the

same time, merge conflicts are unavoidable, so the question isn&#8217;t how to avoid merge conflicts, but how to make those

merge conflicts as painless to deal with as possible. And that&#8217;s one of many places in software delivery where Martin

Fowler&#8217;s quote applies:</p>

</div>

<div class="quoteblock">

<blockquote>

<div class="paragraph">

<p>If it hurts, do it more often.</p>

</div>

</blockquote>

<div class="attribution">

&#8212; Martin Fowler<br>

<cite><a href="http://martinfowler.com/bliki/FrequencyReducesDifficulty.html">Frequency Reduces Difficulty</a></cite>

</div>

</div>

<div class="paragraph">

<p>Merge conflicts hurt. The way to make it hurt less, oddly enough, is to merge more often.</p>

</div>

</div>

<div class="sect3">

<h3 id="_preventing_breakages_with_self_testing_builds">Preventing breakages with self-testing builds</h3>

<div class="paragraph">

<p>The second question that newbies to trunk-based development often ask is, won&#8217;t you be dealing with breakages all

the time? After all, with feature branches, each time you merge, it can take days or weeks to fix all the issues that

come up and stabilize the release branch, but at least you only have to deal with that once every few weeks or months.

Whereas with trunk-based development, wouldn&#8217;t you have to fight with breakages many times per day?</p>

</div>

<div class="paragraph">

<p>Have no fear: this is precisely where the automated testing practices you learned about in

<a href="05.html#how_to_version_build_test">Part 4</a> come to the rescue. Companies that practice CI and trunk-based development configure a

<em>self-testing build</em> that runs automated tests after every commit. This includes commits on any branch, so every time

a developer opens a pull request to merge a branch into <code>main</code>, you automatically run tests against their branch, and

show the test results directly in the pull request UI (you&#8217;ll see an example of how to set this up a little later in

this post). That way, code that doesn&#8217;t pass your test suite doesn&#8217;t get merged to <code>main</code> in

the first place. And if somehow some code does slip through that breaks <code>main</code>, then as soon as you detect it, the

typical solution is to revert that commit automatically. This way, you get <code>main</code> back into working condition quickly,

and the developer who merged in the broken code can redo their commit later, once they&#8217;ve fixed whatever caused the

breakage.</p>

</div>

<div class="paragraph">

<p>The most common way to set up a self-testing build is to run a <em>CI server</em>, which is a piece of software that integrates

with your version control system to run various automations, such as your automated tests, in response

to new commits, branches, and so on. There are many CI servers out there, including some solutions that you run

yourself, such as <a href="https://www.jenkins.io/">Jenkins</a>, <a href="https://www.jetbrains.com/teamcity/">TeamCity</a>,

<a href="https://www.drone.io/">Drone</a>, and <a href="https://argo-cd.readthedocs.io/en/stable/">Argo</a>, and some solutions that are managed

services, such as <a href="https://github.com/features/actions">GitHub Actions</a>, <a href="https://circleci.com/">CircleCi</a>,

and <a href="https://about.gitlab.com/">GitLab</a>.</p>

</div>

<div class="paragraph">

<p>CI servers are such an integral part of continuous integration, that for many developers, the two terms are nearly

synonymous. This is because a CI server and a good suite of automated tests completely changes how you deliver software:</p>

</div>

<div class="quoteblock">

<blockquote>

<div class="paragraph">

<p>Without continuous integration, your software is broken until somebody proves

it works, usually during a testing or integration stage. With continuous

integration, your software is proven to work (assuming a sufficiently

comprehensive set of automated tests) with every new changeand you know the

moment it breaks and can fix it immediately.</p>

</div>

</blockquote>

<div class="attribution">

&#8212; Jez Humble and David Farley<br>

<cite><em>Continuous Delivery: Reliable Software Releases through Build, Test, and Deployment Automation</em> (Addison-Wesley Professional).</cite>

</div>

</div>

<div class="paragraph">

<p>Going from a default of broken to a default of working is a profound transformation. Instead of a multi-day merge

process to prepare your code for release, your code is <em>always</em> in a releasable statewhich means you can deploy

whenever you want. To some extent, the role of a CI server is to act as a gatekeeper, protecting your code from any

changes that jeopardize your ability to deploy at any time.</p>

</div>

<div class="admonitionblock tip">

<table>

<tr>

<td class="icon">

<div class="title">Tip</div>

</td>

<td class="content">

<div class="title">Key takeaway #2</div>

<div class="paragraph">

<p>Use a self-testing build after every commit to ensure your code is always in a working and deployable state.</p>

</div>

</td>

</tr>

</table>

</div>

<div class="paragraph">

<p>In <a href="index.html#world_class_delivery">What world-class software delivery looks like</a>, you saw that companies with world-class software delivery processes are able to deploy

thousands of times per day. Continuous integrationincluding a CI server and thorough automated test suiteis one of

the key ingredients that makes this possible; you&#8217;ll see some of the other ingredients throughout this

post.</p>

</div>

</div>

<div class="sect3">

<h3 id="_making_large_changes">Making large changes</h3>

<div class="paragraph">

<p>The third question that newbies to trunk-based development often ask is, how do you handle changes that take a long

time to implement? CI sounds great for small changes, but if youre working on something that will take weeks or

monthse.g., major new features or refactorshow can you merge your incomplete work on a daily basis without breaking

the build or accidentally releasing unfinished features to users?</p>

</div>

<div class="paragraph">

<p>There are two approaches that you can use to resolve this:</p>

</div>

<div class="admonitionblock tip">

<table>

<tr>

<td class="icon">

<div class="title">Tip</div>

</td>

<td class="content">

<div class="title">Key takeaway #3</div>

<div class="paragraph">

<p>Use branch by abstraction and feature toggles to make large-scale changes while still merging your work on a regular

basis.</p>

</div>

</td>

</tr>

</table>

</div>

<div class="paragraph">

<p>What are branch by abstraction and feature toggles? These two techniques are the focus of the next two sections.</p>

</div>

<div class="sect4">

<h4 id="branch_by_abstraction">Branch by abstraction</h4>

<div class="paragraph">

<p><em>Branch by abstraction</em> is a technique that allows you to make large-scale changes to your code incrementally, across

many commits, without ever risking breaking the build or releasing unfinished work to users. For example, let&#8217;s say you

have hundreds of modules in your codebase that use Library X, as shown in <a href="06.html#branch_by_abstraction_step_1">Figure 41</a>:</p>

</div>

<div id="branch_by_abstraction_step_1" class="imageblock">

<div class="content">

<img src="images/ch5/branch-by-abstraction-1.png" alt="Library X is used across many modules in your codebase">

</div>

<div class="title">Figure 41. Library X is used across many modules in your codebase</div>

</div>

<div class="paragraph">

<p>You want to replace Library X with Library Y, but this will require updating hundreds of modules, which could take

months. If you do this work in a feature branch, by the time you merge it back, there&#8217;s a good chance you&#8217;ll have merge

conflicts with many of the updated modules, and it&#8217;s possible new usages will have shown up in the meantime, so you&#8217;d

have even more work to do.</p>

</div>

<div class="paragraph">

<p>Instead of a feature branch, the idea with branch by abstraction is to keep working on <code>main</code>, but to introduce a new

<em>abstraction</em> into the codebase. What type of abstraction you use depends on your programming language: it might be an

interface, a protocol, a class, etc. The important thing is that (a) the abstraction initially uses Library X under the

hood, so there is no change in behavior and (b) it creates a layer of indirection between your modules and Library X,

as shown in <a href="06.html#branch_by_abstraction_step_2">Figure 42</a>:</p>

</div>

<div id="branch_by_abstraction_step_2" class="imageblock">

<div class="content">

<img src="images/ch5/branch-by-abstraction-2.png" alt="Introduce an abstraction between your modules and Library X">

</div>

<div class="title">Figure 42. Introduce an abstraction between your modules and Library X</div>

</div>

<div class="paragraph">

<p>You can update your modules to use the abstraction incrementally, across many commits to <code>main</code>. There&#8217;s no hurry or

risk of breakage, as under the hood, the abstraction is still using Library X. After some time, all modules should be

using the abstraction, and you could even add an automated test that fails if anyone tries to use Library X directly.</p>

</div>

<div class="paragraph">

<p>At this point, you can start replacing Library X with Library Y, as shown in <a href="06.html#branch_by_abstraction_step_3">Figure 43</a>:</p>

</div>

<div id="branch_by_abstraction_step_3" class="imageblock">

<div class="content">

<img src="images/ch5/branch-by-abstraction-3.png" alt="Start to incrementally update your modules to use Library Y">

</div>

<div class="title">Figure 43. Start to incrementally update your modules to use Library Y</div>

</div>

<div class="paragraph">

<p>Again, you can roll out this change incrementally, across many commits to <code>main</code>, integrating your work regularly to

minimize merge conflicts. You could also update your abstraction code to ensure that any new usages of the abstraction

get Library Y under the hood by default. Eventually, when you&#8217;re done updating all module usages, you can remove

Library X entirely, as shown in <a href="06.html#branch_by_abstraction_step_4">Figure 44</a>:</p>

</div>

<div id="branch_by_abstraction_step_4" class="imageblock">

<div class="content">

<img src="images/ch5/branch-by-abstraction-4.png" alt="After you&#8217;ve updated all module usages, you can remove Library X">

</div>

<div class="title">Figure 44. After you&#8217;ve updated all module usages, you can remove Library X</div>

</div>

<div class="paragraph">

<p>Branch by abstraction is a great technique for doing large-scale refactors. But what if you need to introduce totally

new functionality? If that functionality takes weeks or months to implement, how can you merge it regularly into <code>main</code>

without accidentally releasing unfinished features to users? This is when you turn to the second approach, feature

toggles, as described next.</p>

</div>

</div>

<div class="sect4">

<h4 id="feature_toggles">Feature toggles</h4>

<div class="paragraph">

<p>The idea with <em>feature toggles</em> (AKA <em>feature flags</em>) is to wrap new functionality in conditionals that let you turn

(toggle) those features on and off dynamically. For example, imagine that you wanted to take the Node.js sample app

you&#8217;ve been using throughout this blog post series, and to update it to return a proper home page that is a little more

interesting than the "Hello, World!" text. However, it&#8217;s going to take you several months to implement this new home

page. The idea with a feature toggle is to add a conditional to your code as shown in <a href="06.html#feature_toggle_example">Example 89</a> (you

don&#8217;t need to actually make these code changes; this is just for demonstration purposes):</p>

</div>

<div id="feature_toggle_example" class="exampleblock">

<div class="title">Example 89. An example of using a feature toggle to pick between the new home page and the original "Hello, World!" text (<em>ch5/sample-app/app.js</em>)</div>

<div class="content">

<div class="listingblock">

<div class="content">

<pre class="CodeRay highlight"><code data-lang="javascript">app.get(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/</span><span style="color:#710">'</span></span>, (req, res) =&gt; {

  <span style="color:#080;font-weight:bold">if</span> (lookupFeatureToggle(req, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">HOME_PAGE_FLAVOR</span><span style="color:#710">&quot;</span></span>) === <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">v2</span><span style="color:#710">&quot;</span></span>) { // <b class="conum">(1)</b>

    res.send(newFancyHomepage());                              // <b class="conum">(2)</b>

  } <span style="color:#080;font-weight:bold">else</span> {

    res.send(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Hello, World!</span><span style="color:#710">'</span></span>);                                 // <b class="conum">(3)</b>

  }

});</code></pre>

</div>

</div>

</div>

</div>

<div class="paragraph">

<p>Here&#8217;s what this code does:</p>

</div>

<div class="colist arabic">

<ol>

<li>

<p>Use the <code>lookupFeatureToggle</code> function to look up the value of the "NEW_HOME_PAGE" feature toggle.</p>

</li>

<li>

<p>If the value of the feature toggle is "v2," send back the contents of the new home page as a response.</p>

</li>

<li>

<p>If the value of the feature toggle is anything else, send back the original "Hello, World!" text.</p>

</li>

</ol>

</div>

<div class="paragraph">

<p>So what does the <code>lookupFeatureToggle</code> function do? Typically, this function will check if the feature toggle is

enabled by querying a dedicated <em>feature toggle service</em>, which is a service that can do the following:</p>

</div>

<div class="dlist">

<dl>

<dt class="hdlist1">Store a feature toggle mapping</dt>

<dd>

<p>The mapping is from a feature toggle name (e.g, NEW_HOME_PAGE) to its value (e.g.,

true, false, or an arbitrary string like "v2").</p>

</dd>

<dt class="hdlist1">Look up feature toggles programmatically</dt>

<dd>

<p>You provide an API or SDK your apps can use to look up the current value

of a feature toggle (e.g., the <code>lookupFeatureToggle</code> function would use this SDK under the hood).</p>

</dd>

<dt class="hdlist1">Update feature toggles without having to change code</dt>

<dd>

<p>You have some sort of web UI, API, or other mechanism that

lets you quickly change the value of a feature toggle at any timewithout having to update or deploy new code.</p>

</dd>

</dl>

</div>

<div class="paragraph">

<p>You could build your own feature toggle service around a database, or deploy an open source feature toggle service

such as <a href="https://github.com/growthbook/growthbook/">growthbook</a>, <a href="https://www.flagsmith.com/">Flagsmith</a>,

<a href="https://github.com/openflagr/flagr">flagr</a>, or <a href="https://openfeature.dev/">OpenFeature</a>, or you could use a managed feature

toggle service such as <a href="https://www.split.io/">Split</a>, <a href="https://launchdarkly.com/">LaunchDarkly</a>,

<a href="https://configcat.com/">ConfigCat</a>, or <a href="https://statsig.com/">Statsig</a>.</p>

</div>

<div class="paragraph">

<p>It might not be obvious, but the humble if-statement, combined with a feature toggle check, unlocks a superpower: you

can now commit and regularly merge code, even before it&#8217;s done. If you wrap new features in a feature toggle check, as

long as the code is syntactically valid (which you can validate with simple automated tests), you can merge your new

feature into <code>main</code> long before that feature is done. That&#8217;s because, by default, feature toggles are off, so no users

will see this feature! This is what allows you to develop large new features while still practicing continuous

integration.</p>

</div>

<div class="paragraph">

<p>What&#8217;s even more surprising is that this is only one of the superpowers you get with feature toggles; you&#8217;ll see a

number of others later in this blog post, in the continuous delivery section.</p>

</div>

</div>

</div>

<div class="sect3">

<h3 id="_example_set_up_automated_tests_for_your_app_code_with_github_actions">Example: set up automated tests for your app code with GitHub Actions</h3>

<div class="admonitionblock note">

<table>

<tr>

<td class="icon">

<div class="title">Note</div>

</td>

<td class="content">

<div class="title">Example Code</div>

<div class="paragraph">

<p>As a reminder, you can find all the code examples in the blog post series&#8217;s <a href="https://github.com/brikis98/fundamentals-of-devops-code">sample

code repo in GitHub</a>.</p>

</div>

</td>

</tr>

</table>

</div>

<div class="paragraph">

<p>Now that you understand the basics of continuous integration, let&#8217;s get a little practice setting up some of the

technology that enables it: namely, a self-testing build. You added some automated tests in <a href="05.html#automated_testing">Section 4.3</a>,

so the goal is to run these tests automatically after each commit, and to show the results in pull requests. In

<a href="05.html#example_store_code_github">Section 4.1.3</a>, you pushed your code to GitHub, so to avoid introducing even more tools, let&#8217;s use

GitHub Actions as the CI server that will run these tests.</p>

</div>

<div class="paragraph">

<p>Head into the folder where you&#8217;ve been working on the code samples for this blog post series and make sure you&#8217;re on

the <code>main</code> branch, with the latest code:</p>

</div>

<div class="listingblock">

<div class="content">

<pre>$ cd fundamentals-of-devops

$ git checkout main

$ git pull origin main</pre>

</div>

</div>

<div class="paragraph">

<p>Next, create a new <em>ch5</em> folder for this blog post&#8217;s code examples, and copy into <em>ch5</em> the

<em>sample-app</em> folder from <a href="05.html#how_to_version_build_test">Part 4</a>, where you had a Node.js app with automated tests:</p>

</div>

<div class="listingblock">

<div class="content">

<pre>$ mkdir -p ch5

$ cp -r ch4/sample-app ch5/sample-app</pre>

</div>

</div>

<div class="paragraph">

<p>With that done, create a new folder called <em>.github/workflows</em>:</p>

</div>

<div class="listingblock">

<div class="content">

<pre>$ mkdir -p .github/workflows

$ cd .github/workflows</pre>

</div>

</div>

<div class="paragraph">

<p>Inside the <em>.github/workflows</em> folder, create a file called <em>app-tests.yml</em>, with the contents shown in

<a href="06.html#gh_actions_workflow_run_app_tests">Example 90</a>:</p>

</div>

<div id="gh_actions_workflow_run_app_tests" class="exampleblock">

<div class="title">Example 90. A GitHub Actions workflow to run the sample app automated tests (<em>.github/workflows/app-tests.yml</em>)</div>

<div class="content">

<div class="listingblock">

<div class="content">

<pre class="CodeRay highlight"><code data-lang="yaml"><span style="color:#606">name</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">Sample App Tests</span></span>



<span style="color:#606">on</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">push                                  </span></span># <b class="conum">(1)</b>



<span style="color:#606">jobs</span>:                                     # <b class="conum">(2)</b>

  <span style="color:#606">sample_app_tests</span>:                       # <b class="conum">(3)</b>

    <span style="color:#606">name</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Run Tests Using Jest</span><span style="color:#710">&quot;</span></span>

    <span style="color:#606">runs-on</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">ubuntu-latest                </span></span># <b class="conum">(4)</b>

    <span style="color:#606">steps</span>:

      - <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">uses: actions/checkout@v2         </span></span># <b class="conum">(5)</b>



      - <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">name: Install dependencies        </span></span># <b class="conum">(6)</b>

        <span style="color:#606">working-directory</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">ch5/sample-app</span></span>

        <span style="color:#606">run</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">npm install</span></span>



      - <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">name: Run tests                   </span></span># <b class="conum">(7)</b>

        <span style="color:#606">working-directory</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">ch5/sample-app</span></span>

        <span style="color:#606">run</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">npm test</span></span></code></pre>

</div>

</div>

</div>

</div>

<div class="paragraph">

<p>With GitHub Actions, you use YAML to define <em>workflows</em>, which are configurable automated processes that run one or

more jobs in response to certain <em>triggers</em>. Here&#8217;s what the preceding workflow does:</p>

</div>

<div class="colist arabic">

<ol>

<li>

<p>The <code>on</code> block is where you define the triggers that will cause this workflow to run. The preceding code configures

this workflow to run every time you do a <code>git push</code> to this repo.</p>

</li>

<li>

<p>The <code>jobs</code> block defines one or more jobsautomationsto run in this workflow. By default, jobs run sequentially,

but you can also configure jobs that run concurrently, as well as creating dependencies and passing data between

jobs.</p>

</li>

<li>

<p>This workflow defines just a single job, which will run the automated tests for the sample app.</p>

</li>

<li>

<p>Each job runs on a certain type of <em>runner</em>, which is how you configure the hardware (CPU, memory) and software

(operating system and dependencies) to use for the build. The preceding code uses a runner with the default hardware

configuration (2 CPUs and 7GB of RAM, as of 2024) and a software configuration that has Ubuntu and a bunch of

commonly used software engineering tools (including Node.js) pre-installed.<sup class="footnote">[<a id="_footnoteref_37" class="footnote" href="13-footnotes.html#_footnotedef_37" title="View footnote.">37</a>]</sup></p>

</li>

<li>

<p>Each job consists of a series of steps that are executed sequentially. The first step in this job runs another

workflow via the <code>uses</code> keyword. This is one of the best features of GitHub Actions: you can share and reuse

workflows, including both public, open source workflows (which you can discover in the

<a href="https://github.com/marketplace?category=type=actions">GitHub Actions Marketplace</a>) and private, internal workflows

within your own organization. The preceding code uses the <code>actions/checkout</code> workflow to check out the code for

your repo (it calls <code>git clone</code> under the hood).</p>

</li>

<li>

<p>The second step in this job use the <code>run</code> keyword to execute shell commands. In particular, it runs

<code>npm install</code> in the <em>ch5/sample-app</em> folder to install the sample app&#8217;s dependencies.</p>

</li>

<li>

<p>The third step in this job uses the <code>run</code> keyword to execute <code>npm test</code>, which runs the sample-app&#8217;s automated

tests.</p>

</li>

</ol>

</div>

<div class="paragraph">

<p>If all the steps succeed, the job will be marked as successful (green); if any step failse.g., <code>npm test</code> exits

with a non-zero exit code because one of the tests failsthen the job will be marked as failed (red).</p>

</div>

<div class="paragraph">

<p>To try it out, first commit and push the sample app and workflow code to your repo:</p>

</div>

<div class="listingblock">

<div class="content">

<pre>$ git add ch5/sample-app .github/workflows/app-tests.yml

$ git commit -m "Add sample-app and workflow"

$ git push origin main</pre>

</div>

</div>

<div class="paragraph">

<p>Next, create a new branch called <code>test-workflow</code> to see this workflow in action:</p>

</div>

<div class="listingblock">

<div class="content">

<pre>$ git checkout -b test-workflow</pre>

</div>

</div>

<div class="paragraph">

<p>Make a change to the sample app to intentionally return some text other than "Hello, World!", as shown in

<a href="06.html#sample_app_alternate_text">Example 91</a>:</p>

</div>

<div id="sample_app_alternate_text" class="exampleblock">

<div class="title">Example 91. Change the sample app to return a different response (<em>ch5/sample-app/app.js</em>)</div>

<div class="content">

<div class="listingblock">

<div class="content">

<pre class="CodeRay highlight"><code data-lang="javascript">res.send(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Fundamentals of DevOps!</span><span style="color:#710">'</span></span>);</code></pre>

</div>

</div>

</div>

</div>

<div class="paragraph">

<p>Commit and push these changes to the <code>test-workflow</code> branch:</p>

</div>

<div class="listingblock">

<div class="content">

<pre>$ git add ch5/sample-app/app.js

$ git commit -m "Change response text"

$ git push origin test-workflow</pre>

</div>

</div>

<div class="paragraph">

<p>After running <code>git push</code>, the log output will show you the GitHub URL to open a pull request. Open that URL in

your browser, fill out a title and description, and click "Create pull request." You should get a page that looks

something like <a href="06.html#pull_request_tests">Figure 45</a>:</p>

</div>

<div id="pull_request_tests" class="imageblock">

<div class="content">

<img src="images/ch5/pull-request-tests.png" alt="Automated tests running in a pull request">

</div>

<div class="title">Figure 45. Automated tests running in a pull request</div>

</div>

<div class="paragraph">

<p>At the bottom of the pull request, you should see the "Sample App Tests" workflow has run: and, uh oh, looks like

there&#8217;s an error. Click the Details link to the right of the workflow to see what went wrong. You should get a page

that looks like <a href="06.html#gh_actions_test_failure">Figure 46</a>:</p>

</div>

<div id="gh_actions_test_failure" class="imageblock">

<div class="content">

<img src="images/ch5/gh-actions-test-failure.png" alt="Looking into the cause of the test failure">

</div>

<div class="title">Figure 46. Looking into the cause of the test failure</div>

</div>

<div class="paragraph">

<p>Aha! The automated test is still expecting the response text to be "Hello, World!" To fix this issue, update

<em>app.test.js</em> to expect "Fundamentals of DevOps!" as a response, as shown in <a href="06.html#sample_app_test_update">Example 92</a>:</p>

</div>

<div id="sample_app_test_update" class="exampleblock">

<div class="title">Example 92. Updated the automated test to expect the new response text (<em>ch5/sample-app/app.test.js</em>)</div>

<div class="content">

<div class="listingblock">

<div class="content">

<pre class="CodeRay highlight"><code data-lang="javascript">expect(response.text).toBe(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Fundamentals of DevOps!</span><span style="color:#710">'</span></span>);</code></pre>

</div>

</div>

</div>

</div>

<div class="paragraph">

<p>Commit and push these changes to the <code>test-workflow</code> branch:</p>

</div>

<div class="listingblock">

<div class="content">

<pre>$ git add ch5/sample-app/app.test.js

$ git commit -m "Update response text in test"

$ git push origin test-workflow</pre>

</div>

</div>

<div class="paragraph">

<p>This will automatically update your open PR, and automatically re-run your tests. After a few seconds, if you go back

to your browser and look at the PR, you should see the tests passing, as shown in <a href="06.html#gh_actions_test_passing">Figure 47</a>:</p>

</div>

<div id="gh_actions_test_passing" class="imageblock">

<div class="content">

<img src="images/ch5/gh-actions-tests-pass.png" alt="The automated tests should now be passing">

</div>

<div class="title">Figure 47. The automated tests should now be passing</div>

</div>

<div class="paragraph">

<p>Congrats, you now have a self-testing build that will automatically run your app&#8217;s tests after every commit, and show

you the results in every PR. Merge the PR, and let&#8217;s move on to adding automated tests for the infrastructure code.</p>

</div>

<div class="admonitionblock tip">

<table>

<tr>

<td class="icon">

<div class="title">Tip</div>

</td>

<td class="content">

<div class="title">Get your hands dirty</div>

<div class="paragraph">

<p>Here are a few exercises you can try at home to get a better feel for running automated app tests in CI:</p>

</div>

<div class="ulist">

<ul>

<li>

<p>To help catch bugs, update the GitHub Actions workflow to run a JavaScript linter, such as

<a href="https://www.jslint.com/">JSLint</a> or <a href="https://eslint.org/">ESLint</a>, after every commit.</p>

</li>

<li>

<p>To help keep your code consistently formatted, update the GitHub Actions workflow to run a code formatter, such as

<a href="https://prettier.io/">Prettier</a>, after every commit.</p>

</li>

<li>

<p>Run both the linter and code formatter as a <em>precommit hook</em>, so these checks run on your own computer <em>before</em>

you can make a commit. You may wish to use the <a href="https://pre-commit.com/">pre-commit</a> framework to manage your precommit

hooks.</p>

</li>

</ul>

</div>

</td>

</tr>

</table>

</div>

</div>

<div class="sect3">

<h3 id="_machine_user_credentials_and_automatically_provisioned_credentials">Machine user credentials and automatically-provisioned credentials</h3>

<div class="paragraph">

<p>Now that you&#8217;ve seen how to configure a CI server to run the sample app&#8217;s automated tests, you may want to update the

CI server to also run the infrastructure automated tests that you added in <a href="05.html#how_to_version_build_test">Part 4</a>. In that

blog post, you added two types of automated tests for your infrastructure code: static analysis with

Terrascan and unit testing with OpenTofu&#8217;s <code>test</code> command. Since the latter type of test deploys real resources into a

real AWS account, you will need to give your automated tests a way to authenticate to AWS.</p>

</div>

<div class="paragraph">

<p>This is a somewhat tricky problem. When a human being needs to authenticate to a machine, you can rely on that human

memorizing some sort of secret, such as a password. But what do you do when a machine, such as a CI server, needs to

authenticate to another machine? How can that machine "memorize" some sort of secret without leaking that secret

to everyone else? You&#8217;ll learn various approaches to solve this problem in <a href="08.html#how_to_manage_auth_and_secrets">Part 7</a>.</p>

</div>

<div class="paragraph">

<p>For now, all you need to know is that you should <em>never</em> use a real user&#8217;s credentials to solve this problem. That is,

do <em>not</em> use your own IAM user credentials, or your own GitHub personal access token, or any type of credentials from

any human being in a CI server or other types of automation. Here&#8217;s why:</p>

</div>

<div class="dlist">

<dl>

<dt class="hdlist1">Departures</dt>

<dd>

<p>Typically, when someone leaves a company, you revoke all their access. If you were using their

credentials for automation, then that automation will suddenly break.</p>

</dd>

<dt class="hdlist1">Permissions</dt>

<dd>

<p>The permissions that a human user needs are typically different than a machine user.</p>

</dd>

<dt class="hdlist1">Audit logs</dt>

<dd>

<p>Most systems maintain an <em>audit log</em> that records who performed what actions in that system. These sorts

of logs are useful for debugging and investigating security incidentsunless the same user account is used both by

a human and automation, in which case, it&#8217;s harder to tell who did what.</p>

</dd>

<dt class="hdlist1">Management</dt>

<dd>

<p>You typically want multiple developers at your company to be able to manage the automations you set up.

If you use a single developer&#8217;s credentials for those automations, then the other developers won&#8217;t be able to access

that user account if they need to update the credentials or permissions.</p>

</dd>

</dl>

</div>

<div class="paragraph">

<p>So if you can&#8217;t use the credentials of a real user, what do you do? These days, there are two main options:</p>

</div>

<div class="admonitionblock tip">

<table>

<tr>

<td class="icon">

<div class="title">Tip</div>

</td>

<td class="content">

<div class="title">Key takeaway #4</div>

<div class="paragraph">

<p>Use machine user credentials or automatically-provisioned credentials to authenticate from a CI server or other

automations.</p>

</div>

</td>

</tr>

</table>

</div>

<div class="paragraph">

<p>What are machine user credentials or automatically-provisioned credentials? These are the topics of the next two

sections.</p>

</div>

<div class="sect4">

<h4 id="_machine_user_credentials">Machine user credentials</h4>

<div class="paragraph">

<p>One way to allow automated tools to authenticate is to create a dedicated <em>machine user</em>, which is a user account that

is <em>only</em> used for automation (not by any human user). You create the user, generate credentials for them (e.g., access

keys), and copy those credentials into whatever tool you&#8217;re using (e.g., into GitHub).</p>

</div>

<div class="paragraph">

<p>Machine users have a number of advantages: they never depart your company; you can assign them just the permissions

they need; no human ever logs in as a machine user, so they only show up in audit logs when used in your automations;

and you can share access to a single machine user account across your team by using a secrets management tool (a topic

you&#8217;ll learn more about in <a href="08.html#how_to_manage_auth_and_secrets">Part 7</a>).</p>

</div>

<div class="paragraph">

<p>However, machine users also have some drawbacks: one drawback is that you have to copy their credentials around

manually, which is tedious and error-prone; another drawback is that the credentials you&#8217;re copying are typically

<em>long-lived credentials</em>, which don&#8217;t expire for a long time (if ever), so if these credentials are ever leaked, there

is a long or even indefinite window of time during which they could be exploited.</p>

</div>

<div class="paragraph">

<p>With some tools, machine users are the best you can do, but these days, some systems support automatically-provisioned

credentials, as described in the next section.</p>

</div>

</div>

<div class="sect4">

<h4 id="_automatically_provisioned_credentials">Automatically-provisioned credentials</h4>

<div class="paragraph">

<p>A second way to allow automated tools to authenticate is to use <em>automatically-provisioned credentials</em>, which are

credentials the system can generate automatically, without any need for you to manually create machine users or

copy/paste credentials. This requires that the system you&#8217;re authenticating from (e.g. a CI server) and the system

you&#8217;re authenticating to (e.g., AWS) have an integration between them that supports automatically-provisioned

credentials.</p>

</div>

<div class="paragraph">

<p>You&#8217;ve actually seen one form of automatically-provisioned credentials already earlier in this blog post series: IAM

roles. Some of the resources you&#8217;ve deployed in AWS, such as the EKS cluster in <a href="04.html#how_to_deploy_many_apps">Part 3</a>, used IAM

roles to authenticate and make API calls within your AWS account (e.g., to deploy EC2 instances as EKS worker nodes).

You didn&#8217;t have to create a machine user or manually manage credentials to make this work: instead, under the hood, AWS

automatically provisioned credentials that the EKS cluster could use.</p>

</div>

<div class="paragraph">

<p>With IAM roles, the thing you&#8217;re authenticating from and the thing you&#8217;re authenticating to are both AWS, but there are

also systems that support automatically-provisioned credentials across different companies and services. One of the

most common is <em>Open ID Connect (OIDC)</em>, which is an open protocol for authentication. Not all services support OIDC,

so it&#8217;s not always an option, but in the cases where it is supported, it&#8217;s usually a more secure choice than machine

user credentials, as OIDC gives you not only automatically-provisioned credentials (so no manual copy/paste), but also

<em>short-lived credentials</em> that expire after a configurable period of time (e.g., one hour).</p>

</div>

<div class="paragraph">

<p>One place where OIDC is supported is between AWS and GitHub. To set up OIDC with AWS and GitHub, you configure your AWS

account to trust an <em>identity provider (IdP)</em>, such as GitHub, whose identity AWS can verify cryptographically

(using a fingerprint you provide for GitHub), and then you can grant that provider permissions to assume specific IAM

roles, subject to certain conditions: e.g., you can only use this IAM role from certain repos or branches.</p>

</div>

<div id="oidc_github_diagram" class="imageblock">

<div class="content">

<img src="images/ch5/oidc-github-diagram.png" alt="With OIDC, you configure AWS to trust an IdP such as GitHub, which allows that IdP to exchange an OIDC token for short-lived AWS credentials">

</div>

<div class="title">Figure 48. With OIDC, you configure AWS to trust an IdP such as GitHub, which allows that IdP to exchange an OIDC token for short-lived AWS credentials</div>

</div>

<div class="paragraph">

<p>Once you&#8217;ve set that up, <a href="06.html#oidc_github_diagram">Figure 48</a> shows the workflow for using OIDC to authenticate from GitHub to

AWS:</p>

</div>

<div class="olist arabic">

<ol class="arabic">

<li>

<p><strong>[GitHub] Generate an OIDC token</strong>: Inside a GitHub Actions workflow, GitHub generates an <em>OIDC token</em>, which is a

<a href="https://jwt.io/">JSON Web Token</a>: that is, a JSON object that contains <em>claims</em>that is, data that GitHub is

assertingand a signature that can be cryptographically verified to prove the token really comes from GitHub. GitHub

includes several claims, including information about what repo and branch the workflow is running in.</p>

</li>

<li>

<p><strong>[GitHub] Call the <code>AssumeRoleWithWebIdentity</code> API</strong>: The workflow then calls the AWS <code>AssumeRoleWithWebIdentity</code> API,

specifying an IAM Role to assume, and passing the OIDC token to AWS as authentication.</p>

</li>

<li>

<p><strong>[AWS] Validate the OIDC token</strong>: AWS first validates the signature on the token to make sure it really came from

GitHub, using a thumbprint you provide when setting up GitHub as an OpenID provider.</p>

</li>

<li>

<p><strong>[AWS] Validate IAM role conditions</strong>: Next, AWS validates the conditions on the IAM role against the claims in the

token, especially whether that particular repo and branch is allowed to assume the IAM role.</p>

</li>

<li>

<p><strong>[AWS] Grant short-lived AWS credentials</strong>: If all the validations pass, AWS generates temporary AWS credentials that

give you access to the IAM role&#8217;s permissions for a short period of time, and sends those back to GitHub.</p>

</li>

<li>

<p><strong>[GitHub] Use the AWS credentials</strong>: Finally, the tools in your GitHub Actions workflow, such as OpenTofu, can use the

AWS credentials to authenticate to AWS and make changes in your AWS account.</p>

</li>

</ol>

</div>

</div>

</div>

<div class="sect3">

<h3 id="_example_configure_oidc_for_use_with_automated_tests_in_github_actions">Example: configure OIDC for use with automated tests in GitHub Actions</h3>

<div class="paragraph">

<p>Since OIDC is a more secure option than machine user credentials, let&#8217;s try it out. You&#8217;re going to set up an OIDC

provider and IAM roles so that the automated tests you wrote for the <code>lambda-sample</code> OpenTofu module in

<a href="05.html#how_to_version_build_test">Part 4</a> can authenticate to AWS from GitHub Actions. The first step is to set up the OIDC

provider. The blog post series&#8217;s <a href="https://github.com/brikis98/fundamentals-of-devops-code">sample code repo</a> includes an OpenTofu module called

<code>github-aws-oidc</code> in the <em>ch5/tofu/modules/github-aws-oidc</em> folder that you can use to configure GitHub as an OIDC

provider.</p>

</div>

<div class="paragraph">

<p>Switch back to the <code>main</code> branch, pull down the latest changes (i.e., the PR you just merged), and create a new branch

called <code>opentofu-tests</code>:</p>

</div>

<div class="listingblock">

<div class="content">

<pre>$ git checkout main

$ git pull origin main

$ git checkout -b opentofu-tests</pre>

</div>

</div>

<div class="paragraph">

<p>Next, create a new folder for a root module called <em>ci-cd-permissions</em>:</p>

</div>

<div class="listingblock">

<div class="content">

<pre>$ mkdir -p ch5/tofu/live/ci-cd-permissions

$ cd ch5/tofu/live/ci-cd-permissions</pre>

</div>

</div>

<div class="paragraph">

<p>In the <em>ci-cd-permissions</em> folder, create <em>main.tf</em> with the initial contents shown in <a href="06.html#tofu_oidc_provider">Example 93</a>:</p>

</div>

<div id="tofu_oidc_provider" class="exampleblock">

<div class="title">Example 93. Configure the <code>github-aws-oidc</code> module (<em>ch5/tofu/live/ci-cd-permissions/main.tf</em>)</div>

<div class="content">

<div class="listingblock">

<div class="content">

<pre class="CodeRay highlight"><code data-lang="terraform">provider &quot;aws&quot; {

  region = &quot;us-east-2&quot;

}



module &quot;oidc_provider&quot; {

  source = &quot;github.com/brikis98/fundamentals-of-devops-code//ch5/tofu/modules/github-aws-oidc&quot;



  provider_url = &quot;https://token.actions.githubusercontent.com&quot; # <b class="conum">(1)</b>

}</code></pre>

</div>

</div>

</div>

</div>

<div class="paragraph">

<p>This code sets the following parameters:</p>

</div>

<div class="colist arabic">

<ol>

<li>

<p><code>provider_url</code>: The URL of the IdP. The preceding code sets this to the URL GitHub uses for OIDC. The

<code>github-aws-oidc</code> module will also use this URL to fetch GitHub&#8217;s fingerprint, which AWS will use to

cryptographically validate OIDC tokens.</p>

</li>

</ol>

</div>

<div class="paragraph">

<p>In addition to the OIDC provider, you also need to create an IAM role that you can assume from GitHub Actions (using

OIDC) for testing. The blog post series&#8217;s sample code repo has a module for that too: it&#8217;s called

<code>gh-actions-iam-roles</code>, it lives in the <em>ch5/tofu/modules/gh-actions-iam-roles</em> folder, and it knows how to create

several IAM roles for CI/CD with GitHub Actions. <a href="06.html#tofu_oidc_iam_role_tests">Example 94</a> shows how to update your

<code>ci-cd-permissions</code> module to make use of the <code>gh-actions-iam-roles</code> module:</p>

</div>

<div id="tofu_oidc_iam_role_tests" class="exampleblock">

<div class="title">Example 94. Configure the <code>gh-actions-iam-roles</code> module (<em>ch5/tofu/live/ci-cd-permissions/main.tf</em>)</div>

<div class="content">

<div class="listingblock">

<div class="content">

<pre class="CodeRay highlight"><code data-lang="terraform">module &quot;iam_roles&quot; {

  source = &quot;github.com/brikis98/fundamentals-of-devops-code//ch5/tofu/modules/gh-actions-iam-roles&quot;



  name              = &quot;lambda-sample&quot;                           # <b class="conum">(1)</b>

  oidc_provider_arn = module.oidc_provider.oidc_provider_arn    # <b class="conum">(2)</b>



  enable_iam_role_for_testing = true                            # <b class="conum">(3)</b>



  # TODO: fill in your own repo name here!

  github_repo      = &quot;brikis98/fundamentals-of-devops-examples&quot; # <b class="conum">(4)</b>

  lambda_base_name = &quot;lambda-sample&quot;                            # <b class="conum">(5)</b>

}</code></pre>

</div>

</div>

</div>

</div>

<div class="paragraph">

<p>This code configures the following parameters:</p>

</div>

<div class="colist arabic">

<ol>

<li>

<p><code>name</code>: The base name for the IAM roles and all other resources created by this module. The preceding code sets this

to "lambda-sample," so the IAM role for testing will be called "lambda-sample-tests."</p>

</li>

<li>

<p><code>oidc_provider_arn</code>: Specify the OIDC provider that will be allowed to assume the IAM roles created by this module.

The preceding code sets this to the OIDC provider you just created using the <code>github-aws-oidc</code> module. Under the

hood, the <code>gh-actions-iam-roles</code> module will configure the <em>trust policy</em> in the IAM roles to trust this OIDC

provider and allow it to assume the IAM roles.</p>

</li>

<li>

<p><code>enable_iam_role_for_testing</code>: If set to true, create the IAM role specifically for automated testing. You&#8217;ll see

the other IAM roles this module can create later in this blog post.</p>

</li>

<li>

<p><code>github_repo</code>: The GitHub repo that will be allowed to assume the IAM roles using OIDC. You will need to fill in

your own GitHub repo name here. Under the hood, the <code>gh-actions-iam-roles</code> module sets certain conditions in the

trust policies of each IAM role to specify which repos and branches in GitHub are allowed to assume that IAM role.

For the testing IAM role, all branches in the specified repo will be allowed to assume the IAM role.</p>

</li>

<li>

<p><code>lambda_base_name</code>: The base name you use for the <code>lambda-sample</code> module and all the resources it creates. This

should be the same value you use for the <code>name</code> parameter in that module. This is necessary so the

<code>gh-actions-iam-roles</code> module can create IAM roles with permissions to manage the <code>lambda-sample</code> resources, but

not anything else.</p>

</li>

</ol>

</div>

<div class="paragraph">

<p>You should also create a file called <em>outputs.tf</em> that outputs the testing IAM role ARN, as shown in

<a href="06.html#tofu_oidc_iam_role_outputs">Example 95</a>:</p>

</div>

<div id="tofu_oidc_iam_role_outputs" class="exampleblock">

<div class="title">Example 95. The output variables for the <code>ci-cd-permissions</code> module (<em>ch5/tofu/live/ci-cd-permissions/outputs.tf</em>)</div>

<div class="content">

<div class="listingblock">

<div class="content">

<pre class="CodeRay highlight"><code data-lang="terraform">output &quot;lambda_test_role_arn&quot; {

  value = module.iam_roles.lambda_test_role_arn

}</code></pre>

</div>

</div>

</div>

</div>

<div class="paragraph">

<p>Deploy this module as usual: authenticate to AWS as described in <a href="03.html#example_authenticate_on_the_cli">Section 2.2</a>, and run

<code>init</code> and <code>apply</code>:</p>

</div>

<div class="listingblock">

<div class="content">

<pre>$ tofu init

$ tofu apply</pre>

</div>

</div>

<div class="paragraph">

<p>After <code>apply</code> completes, you should see an output variable:</p>

</div>

<div class="listingblock">

<div class="content">

<pre>Apply complete! Resources: 3 added, 0 changed, 0 destroyed.



Outputs:



lambda_test_role_arn = "arn:aws:iam::111111111111:role/lambda-tests"</pre>

</div>

</div>

<div class="paragraph">

<p>Take note of the <code>lambda_test_role_arn</code> output value, as you&#8217;ll need it soon.</p>

</div>

<div class="paragraph">

<p>Now that OIDC provider and IAM role are in place, you can finally set up the automated tests for your infrastructure

code.</p>

</div>

</div>

<div class="sect3">

<h3 id="_example_set_up_automated_tests_for_infrastructure_code_with_github_actions">Example: set up automated tests for infrastructure code with GitHub Actions</h3>

<div class="paragraph">

<p>To run the automated tests for your infrastructure code in GitHub Actions, you first need the infrastructure code

itself. Copy over the <code>lambda-sample</code> module that had automated tests from <a href="05.html#how_to_version_build_test">Part 4</a>, as well as the

<code>test-endpoint</code> module that those tests used under the hood:</p>

</div>

<div class="listingblock">

<div class="content">

<pre>$ cd fundamentals-of-devops

$ mkdir -p ch5/tofu/modules

$ cp -r ch4/tofu/live/lambda-sample ch5/tofu/live

$ cp -r ch4/tofu/modules/test-endpoint ch5/tofu/modules/test-endpoint</pre>

</div>

</div>

<div class="paragraph">

<p>Now you have the code to test, but you should make some changes to it before running those tests in a CI environment.

In a CI environment, you may have many tests running concurrently, which is a good thing, as it can help reduce test

times. However, the <code>lambda-sample</code> module currently hard-codes the names of all of its resources (e.g., it hard-codes

the name of the Lambda function, the IAM role, and so on), so if several developers are running that test concurrently

in CI, you&#8217;ll get errors due to name conflicts, as AWS requires Lambda function and IAM role names to be unique.</p>

</div>

<div class="paragraph">

<p>To fix this issue, the first step is to add a <em>variables.tf</em> file to the <code>lambda-sample</code> module with the

contents shown in <a href="06.html#tofu_lambda_variables">Example 96</a>:</p>

</div>

<div id="tofu_lambda_variables" class="exampleblock">

<div class="title">Example 96. Define an input variable for the <code>lambda-sample</code> module (<em>ch5/tofu/live/lambda-sample/variables.tf</em>)</div>

<div class="content">

<div class="listingblock">

<div class="content">

<pre class="CodeRay highlight"><code data-lang="terraform">variable &quot;name&quot; {

  description = &quot;The base name for the function and all other resources&quot;

  type        = string

  default     = &quot;lambda-sample&quot;

}</code></pre>

</div>

</div>

</div>

</div>

<div class="paragraph">

<p>This defines a <code>name</code> variable which you can use to namespace all the resources created by this module. The <code>default</code>

value is "lambda-sample," which is exactly the value the module used before, so the default behavior doesn&#8217;t change,

but by exposing this input variable, you&#8217;ll be able to override the value at test time.</p>

</div>

<div class="paragraph">

<p>Next, update <em>main.tf</em> to use <code>var.name</code> instead of any hard-coded names, as shown in <a href="06.html#tofu_lambda_main_name">Example 97</a>:</p>

</div>

<div id="tofu_lambda_main_name" class="exampleblock">

<div class="title">Example 97. Update the <code>lambda-sample</code> module to use the <code>name</code> input variable instead of hard-coded names (<em>ch5/tofu/live/lambda-sample/main.tf</em>)</div>

<div class="content">

<div class="listingblock">

<div class="content">

<pre class="CodeRay highlight"><code data-lang="terraform">module &quot;function&quot; {



  # ... (other params omitted) ...



  name = var.name

}

module &quot;gateway&quot; {



  # ... (other params omitted) ...



  name = var.name

}</code></pre>

</div>

</div>

</div>

</div>

<div class="paragraph">

<p>Now you can create a new workflow called <em>infra-tests.yml</em> in <em>.github/workflows</em>, with the initial contents shown in

<a href="06.html#gh_actions_workflow_run_infra_tests">Example 98</a>:</p>

</div>

<div id="gh_actions_workflow_run_infra_tests" class="exampleblock">

<div class="title">Example 98. The first half of a GitHub Actions workflow to run the infrastructure automated tests (<em>.github/workflows/infra-tests.yml</em>)</div>

<div class="content">

<div class="listingblock">

<div class="content">

<pre class="CodeRay highlight"><code data-lang="yaml"><span style="color:#606">name</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">Infrastructure Tests</span></span>



<span style="color:#606">on</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">push</span></span>



<span style="color:#606">jobs</span>:

  <span style="color:#606">terrascan</span>:

    <span style="color:#606">name</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Run Terrascan</span><span style="color:#710">&quot;</span></span>

    <span style="color:#606">runs-on</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">ubuntu-latest</span></span>

    <span style="color:#606">steps</span>:

      - <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">uses: actions/checkout@v2</span></span>



      - <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">name: Run Terrascan</span></span>

        <span style="color:#606">uses</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">tenable/terrascan-action@main</span></span>

        <span style="color:#606">with</span>:

          <span style="color:#606">iac_type</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">'terraform'</span></span>

          <span style="color:#606">iac_dir</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">'ch5/tofu/live/lambda-sample'</span></span>

          <span style="color:#606">verbose</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">true</span></span>

          <span style="color:#606">non_recursive</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">true</span></span>

          <span style="color:#606">config_path</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">'ch5/tofu/live/lambda-sample/terrascan.toml'</span></span></code></pre>

</div>

</div>

</div>

</div>

<div class="paragraph">

<p>This workflow, which runs on <code>push</code>, contains two jobs. The preceding code just shows the first job, which uses an open

source workflow to install and run Terrascan, passing it the same parameters as when you ran it manually in

<a href="05.html#how_to_version_build_test">Part 4</a>.</p>

</div>

<div class="paragraph">

<p><a href="06.html#gh_actions_workflow_run_infra_tests_part_2">Example 99</a> shows the second half of the workflow:</p>

</div>

<div id="gh_actions_workflow_run_infra_tests_part_2" class="exampleblock">

<div class="title">Example 99. The second half of a GitHub Actions workflow to run the infrastructure automated tests (<em>.github/workflows/infra-tests.yml</em>)</div>

<div class="content">

<div class="listingblock">

<div class="content">

<pre class="CodeRay highlight"><code data-lang="yaml">  <span style="color:#606">opentofu_test</span>:

    <span style="color:#606">name</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Run OpenTofu tests</span><span style="color:#710">&quot;</span></span>

    <span style="color:#606">runs-on</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">ubuntu-latest</span></span>

    <span style="color:#606">permissions</span>:                                                                # <b class="conum">(1)</b>

      <span style="color:#606">id-token</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">write</span></span>

      <span style="color:#606">contents</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">read</span></span>

    <span style="color:#606">steps</span>:

      - <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">uses: actions/checkout@v2</span></span>



      - <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">uses: aws-actions/configure-aws-credentials@v3                          </span></span># <b class="conum">(2)</b>

        <span style="color:#606">with</span>:

          <span style="color:#777"># TODO: fill in your IAM role ARN!</span>

          <span style="color:#606">role-to-assume</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">arn:aws:iam::111111111111:role/lambda-sample-tests    </span></span># <b class="conum">(3)</b>

          <span style="color:#606">role-session-name</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">tests-${{ github.run_number }}-${{ github.actor }} </span></span># <b class="conum">(4)</b>

          <span style="color:#606">aws-region</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">us-east-2</span></span>



      - <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">uses: opentofu/setup-opentofu@v1                                        </span></span># <b class="conum">(5)</b>



      - <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">name: Tofu Test</span></span>

        <span style="color:#606">env</span>:

          <span style="color:#606">TF_VAR_name</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">lambda-sample-${{ github.run_id }}                       </span></span># <b class="conum">(6)</b>

        <span style="color:#606">working-directory</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">ch5/tofu/live/lambda-sample</span></span>

        <span style="color:#606">run</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">|</span></span>                                                                  # <b class="conum">(7)</b>

          <span style="color:#F00;background-color:#FAA">tofu init -backend=false -input=false</span>

          <span style="color:#F00;background-color:#FAA">tofu test -verbose</span></code></pre>

</div>

</div>

</div>

</div>

<div class="paragraph">

<p>The second half of the workflow adds a job to run OpenTofu tests:</p>

</div>

<div class="colist arabic">

<ol>

<li>

<p>By default, every GitHub Actions job gets <code>contents: read</code> permissions in your repo, which allows that job to

check out the code in the repo. In order to use OIDC, you need to add the <code>id-token: write</code> permissions. This will

allow you to issue an OIDC token for authenticating to AWS in (2).</p>

</li>

<li>

<p>Use an open source workflow to authenticate to AWS using OIDC.</p>

</li>

<li>

<p>The IAM role to assume. Make sure to fill in the IAM role ARN from the <code>lambda_test_role_arn</code> output in the

previous section.</p>

</li>

<li>

<p>The name to use for the session when assuming the IAM role. This shows up in audit logging, so the preceding code

includes useful information in the session name, such as the name of the tests, which run number this in GitHub,

and which GitHub user triggered the workflow.</p>

</li>

<li>

<p>Use an open source workflow to install OpenTofu.</p>

</li>

<li>

<p>Use the environment variable <code>TF_VAR_name</code> to set the <code>name</code> input variable of the <code>lambda-sample</code> module

to a value that includes the GitHub actions run ID, so it will be unique for each test run, and

therefore, avoid problems with running multiple tests concurrently.</p>

</li>

<li>

<p>Kick off the tests by running <code>tofu init</code> and <code>tofu test</code>. Note that the <code>init</code> command sets <code>backend=false</code> to

skip backend initialization. Later in this post, you&#8217;ll start using remote backends with

the <code>lambda-sample</code> module, which is useful for deployment, but not something you want to enable at test time.</p>

</li>

</ol>

</div>

<div class="paragraph">

<p>Add, commit, and push all the changes to the <code>opentofu-tests</code> branch, and then open a pull request. You should see

something similar to <a href="06.html#gh_actions_tests_tofu">Figure 49</a>:</p>

</div>

<div id="gh_actions_tests_tofu" class="imageblock">

<div class="content">

<img src="images/ch5/github-pr-tofu-tests.png" alt="A PR showing the sample app unit tests, Terrascan, and OpenTofu tests running">

</div>

<div class="title">Figure 49. A PR showing the sample app unit tests, Terrascan, and OpenTofu tests running</div>

</div>

<div class="paragraph">

<p>If you look at the bottom of the pull request, you should see all your automated tests running, including both the

automated tests for your app code and for your infrastructure code. After a minute or two, if everything is configured

correctly, and the tests are passing, merge the PR.</p>

</div>

<div class="admonitionblock tip">

<table>

<tr>

<td class="icon">

<div class="title">Tip</div>

</td>

<td class="content">

<div class="title">Get your hands dirty</div>

<div class="paragraph">

<p>Here are a few exercises you can try at home to get a better feel for running automated infrastructure tests in CI:</p>

</div>

<div class="ulist">

<ul>

<li>

<p>To help keep your code consistently formatted, update the GitHub Actions workflow to run a code formatter, such as

<a href="https://opentofu.org/docs/cli/commands/fmt/"><code>tofu fmt</code></a>, after every commit.</p>

</li>

</ul>

</div>

</td>

</tr>

</table>

</div>

<div class="paragraph">

<p>You now have a self-testing build that runs your sample app automated tests, Terrascan, and OpenTofu tests after every

commit. If you keep growing this suite of automated tests, and you regularly integrate changes from all of your

developers, then your code will always be in a deployable state. But how do you actually do the deployments? That&#8217;s the

topic of the next section.</p>

</div>

</div>

</div>

<div class="sect2">

<h2 id="_continuous_delivery_cd">Continuous Delivery (CD)</h2>

<div class="paragraph">

<p><em>Continuous delivery (CD)</em> is a software development practice which is software development practice with the following

key property:</p>

</div>

<div class="admonitionblock tip">

<table>

<tr>

<td class="icon">

<div class="title">Tip</div>

</td>

<td class="content">

<div class="title">Key takeaway #5</div>

<div class="paragraph">

<p>You can deploy to production at any time in a manner that is fast, reliable, and sustainable.</p>

</div>

</td>

</tr>

</table>

</div>

<div class="paragraph">

<p>You could choose to deploy daily, several times a day, thousands of times per day, or even after every single commit

that passes the automated tests; this last approach is known as <em>continuous deployment</em>. But the key with CD is not how

often you deploy, but to ensure that the frequency of deployment is purely a business decisionnot something limited by

your technology.</p>

</div>

<div class="paragraph">

<p>If you&#8217;re used to a painful deploy process that happens only once every few weeks or months, then deploying many times

per day may sound like a nightmareand deploying thousands of times per day probably sounds utterly impossible. But

this is yet another place where, if it hurts, you need to do it more often.</p>

</div>

<div class="paragraph">

<p>To make it possible to deploy more oftenand more importantly, to make it possible to deploy any time you wantyou

typically need to fulfill several requirements:</p>

</div>

<div class="olist arabic">

<ol class="arabic">

<li>

<p><strong>The code is always in a deployable state</strong>: You saw in the previous section that this is the key benefit of

practicing CI. If everyone is integrating their work regularly, and you have a self-testing build with a sufficient

suite of tests, then your code will always be ready to deploy.</p>

</li>

<li>

<p><strong>The deployment process is sufficiently automated</strong>: If you have a deployment process that involves many manual steps,

then you can&#8217;t really practice CD, because manual deployments typically aren&#8217;t fast, reliable, or sustainable. CD

requires that you automate your deployment process.</p>

</li>

</ol>

</div>

<div class="paragraph">

<p>This section focuses on item (2), automating the deployment process. Managing your infrastructure as code, using the

tools in <a href="03.html#how_to_manage_your_infra_as_code">Part 2</a>, gets you a large part of the way there. To get the rest of the way there,

you need to automate the process <em>around</em> using IaC. This includes implementing deployment strategies and a deployment

pipeline, as discussed in the next two subsections.</p>

</div>

<div class="sect3">

<h3 id="_deployment_strategies">Deployment strategies</h3>

<div class="paragraph">

<p>There are many <em>deployment strategies</em> that you can use to roll out changes:</p>

</div>

<div class="ulist">

<ul>

<li>

<p>Downtime deployment</p>

</li>

<li>

<p>Rolling deployment without replacement</p>

</li>

<li>

<p>Rolling deployment with replacement</p>

</li>

<li>

<p>Blue-green deployment</p>

</li>

<li>

<p>Canary deployment</p>

</li>

<li>

<p>Feature toggle deployment</p>

</li>

<li>

<p>Promotion deployment</p>

</li>

<li>

<p>Infrastructure deployment</p>

</li>

</ul>

</div>

<div class="paragraph">

<p>The next several subsections will go over each of these strategies, including a basic overview of the strategy, its

advantages and drawbacks, and common use cases where the strategy is typically a good fit. Note that these strategies

are not mutually exclusive: you can, and often do, combine multiple strategies together.</p>

</div>

<div class="sect4">

<h4 id="_downtime_deployment">Downtime deployment</h4>

<div class="paragraph">

<p>This is the most basic deployment strategy where you take a downtime to roll out changes.</p>

</div>

<div class="dlist">

<dl>

<dt class="hdlist1">Overview</dt>

<dd>

<div id="deployment_strategy_downtime" class="imageblock">

<div class="content">

<img src="images/ch5/deployment-strategy-downtime.png" alt="Downtime deployment">

</div>

<div class="title">Figure 50. Downtime deployment</div>

</div>

<div class="paragraph">

<p>As shown in <a href="06.html#deployment_strategy_downtime">Figure 50</a>:</p>

</div>

<div class="olist arabic">

<ol class="arabic">

<li>

<p>You start with several replicas of v1 of your app running.</p>

</li>

<li>

<p>You take all the v1 nodes down to update them to v2. While the update is happening, your users get an outage.</p>

</li>

<li>

<p>Once the deployment is completed, you have v2 running everywhere, and your users are able to use the app again.</p>

</li>

</ol>

</div>

</dd>

<dt class="hdlist1">Advantages</dt>

<dd>

<div class="dlist">

<dl>

<dt class="hdlist1">Easy to implement</dt>

<dd>

<p>This is the simplest and most basic deployment strategy.</p>

</dd>

<dt class="hdlist1">Works with all types of apps</dt>

<dd>

<p>You can use this strategy with both <em>stateless apps</em>, which are apps that don&#8217;t

need to persist any of the data that they store on their local hard drives (e.g., most web frontend apps are

stateless), and <em>stateful apps</em>, which are applications that store data on their local hard disks that needs to be

persisted across deployments (e.g., any sort of database or distributed data system).</p>

</dd>

</dl>

</div>

</dd>

<dt class="hdlist1">Drawbacks</dt>

<dd>

<div class="dlist">

<dl>

<dt class="hdlist1">Downtime</dt>

<dd>

<p>Users have to suffer through an outage while you do the deployment.</p>

</dd>

</dl>

</div>

</dd>

<dt class="hdlist1">Use cases</dt>

<dd>

<div class="dlist">

<dl>

<dt class="hdlist1">Avoid when possible</dt>

<dd>

<p>In general, I would <em>not</em> recommend using this approach, as these days, there is wide

support for the zero-downtime deployment strategies discussed in the following sections. The only exception is if

downtime cannot practically be avoided, such as in the next few bullet points.</p>

</dd>

<dt class="hdlist1">Single-replica systems</dt>

<dd>

<p>If you have a system with only a single replica, then when you go to update that one

replica, you may have no choice other than taking a downtime. As you learned in <a href="04.html#how_to_deploy_many_apps">Part 3</a>, this

is one of many reasons to run more than a single replica of your app.</p>

</dd>

<dt class="hdlist1">Data migrations</dt>

<dd>

<p>If you are doing a large data migration, doing it without downtime (which often requires

multiple migration steps and replicating all writes across multiple systems) is often 10x more expensive and

error-prone than doing it with a brief downtime.</p>

</dd>

</dl>

</div>

</dd>

</dl>

</div>

</div>

<div class="sect4">

<h4 id="_rolling_deployment_without_replacement">Rolling deployment without replacement</h4>

<div class="paragraph">

<p>This is the deployment strategy you saw in <a href="04.html#how_to_deploy_many_apps">Part 3</a>, where you gradually roll out new versions of

your app onto new servers, and once the new versions of the app start to pass health checks, you gradually remove the

old versions of the app.</p>

</div>

<div class="dlist">

<dl>

<dt class="hdlist1">Overview</dt>

<dd>

<div id="deployment_strategy_rolling_without_replacement" class="imageblock">

<div class="content">

<img src="images/ch5/deployment-strategy-rolling-without-replacement.png" alt="Rolling deployment without replacement">

</div>

<div class="title">Figure 51. Rolling deployment without replacement</div>

</div>

<div class="paragraph">

<p>As shown in <a href="06.html#deployment_strategy_rolling_without_replacement">Figure 51</a>:</p>

</div>

<div class="olist arabic">

<ol class="arabic">

<li>

<p>You start with several replicas of v1 of your app running.</p>

</li>

<li>

<p>You start deploying v2 of your app onto <em>new</em> servers. Once the v2 apps come up and start passing health checks, the

load balancer will send traffic to them, so for some period of time, users may see both v1 and v2 of your app.</p>

</li>

<li>

<p>As the v2 apps start passing health checks, you gradually undeploy the v1 apps, until you end up with just v2 running.</p>

</li>

</ol>

</div>

</dd>

<dt class="hdlist1">Advantages</dt>

<dd>

<div class="dlist">

<dl>

<dt class="hdlist1">No downtime</dt>

<dd>

<p>Your app keeps working for your users during deployments.</p>

</dd>

<dt class="hdlist1">Widely supported</dt>

<dd>

<p>Most deployment tools natively support rolling deployments without replacement.</p>

</dd>

</dl>

</div>

</dd>

<dt class="hdlist1">Drawbacks</dt>

<dd>

<div class="dlist">

<dl>

<dt class="hdlist1">Poor UX</dt>

<dd>

<p>During a rolling deployment, users may see both the old and new versions of your app at the same time,

which can be a jarring user experience, or even cause bugs if you&#8217;re not careful.</p>

</dd>

<dt class="hdlist1">Works only with stateless apps</dt>

<dd>

<p>This version of rolling deployment doesn&#8217;t work with stateful apps, as you deploy

the v2 replicas before taking down the v1 replicas, so those v1 replicas are still using their hard-drives. In the

next section, you&#8217;ll see a version of rolling deployment that does work with stateful apps.</p>

</dd>

</dl>

</div>

</dd>

<dt class="hdlist1">Use cases</dt>

<dd>

<div class="dlist">

<dl>

<dt class="hdlist1">Deploying stateless apps when blue-green deployment isn&#8217;t available</dt>

<dd>

<p>For stateless apps, blue-green deployments,

which you&#8217;ll see a little later in this post, are usually a better option, but not all

systems support them. In those cases, the rolling deployment without replacement, which is widely supported, is

usually your best bet.</p>

</dd>

</dl>

</div>

</dd>

</dl>

</div>

</div>

<div class="sect4">

<h4 id="_rolling_deployment_with_replacement">Rolling deployment with replacement</h4>

<div class="paragraph">

<p>This is nearly identical to the rolling deployment in the previous section, except here, you remove the old version

of the app, in batches, <em>before</em> booting up the new version. This is typically useful for stateful apps, where the

number of replicas you can run is fixed, as each replica has a unique set of data on its local hard-drive that needs to

be persisted across the deployment.</p>

</div>

<div class="dlist">

<dl>

<dt class="hdlist1">Overview</dt>

<dd>

<div id="deployment_strategy_rolling_with_replacement" class="imageblock">

<div class="content">

<img src="images/ch5/deployment-strategy-rolling-with-replacement.png" alt="Rolling deployment with replacement">

</div>

<div class="title">Figure 52. Rolling deployment with replacement</div>

</div>

<div class="paragraph">

<p>As shown in <a href="06.html#deployment_strategy_rolling_with_replacement">Figure 52</a>:</p>

</div>

<div class="olist arabic">

<ol class="arabic">

<li>

<p>You start with several replicas of v1 of your app running, each with a hard-drive attached. These are typically

network-attached hard-drives.</p>

</li>

<li>

<p>You disconnect one v1 replica from the load balancer, shut down the server, and move its hard drive to a new v2

server (since it&#8217;s a network-attached hard-drive, you do the move through software).<sup class="footnote">[<a id="_footnoteref_38" class="footnote" href="13-footnotes.html#_footnotedef_38" title="View footnote.">38</a>]</sup> Once that new v2 server starts passing health checks, the load balancer starts sending traffic

to it.</p>

</li>

<li>

<p>You repeat this process with each v1 server, taking it out of the load balancer rotation, shutting it down, and moving

its hard-drive to a new v2 server, until all replicas are replaced with v2.</p>

</li>

</ol>

</div>

</dd>

<dt class="hdlist1">Advantages</dt>

<dd>

<div class="dlist">

<dl>

<dt class="hdlist1">No downtime</dt>

<dd>

<p>Your app keeps working for your users during deployments.</p>

</dd>

<dt class="hdlist1">Works with all types of apps</dt>

<dd>

<p>You can use this strategy with both stateless and stateful apps.</p>

</dd>

<dt class="hdlist1">Widely supported</dt>

<dd>

<p>Most deployment tools natively support rolling deployments with replacement.</p>

</dd>

</dl>

</div>

</dd>

<dt class="hdlist1">Drawbacks</dt>

<dd>

<div class="dlist">

<dl>

<dt class="hdlist1">Limited support for hard-drive replacement</dt>

<dd>

<p>While most deployment tools support rolling deployment with

replacement, only a small subset of those tools natively support moving hard-drives over while the deployment is

happening.</p>

</dd>

<dt class="hdlist1">Poor UX</dt>

<dd>

<p>During a rolling deployment, users may see both the old and new versions of your app at the same time,

which can be a jarring user experience, or even cause bugs if you&#8217;re not careful.</p>

</dd>

</dl>

</div>

</dd>

<dt class="hdlist1">Use cases</dt>

<dd>

<div class="dlist">

<dl>

<dt class="hdlist1">Deploying stateful apps</dt>

<dd>

<p>This strategy allows you to deploy changes to stateful systems (e.g., distributed data

stores such as Consul, Elasticsearch, and ZooKeeper) without downtime.</p>

</dd>

</dl>

</div>

</dd>

</dl>

</div>

</div>

<div class="sect4">

<h4 id="_blue_green_deployment">Blue-green deployment</h4>

<div class="paragraph">

<p>With blue-green deployments, you bring up the new (green) version of your app, wait for it to be fully ready, and then

instantaneously switch all traffic from the old version (blue) to the new version (green).</p>

</div>

<div class="dlist">

<dl>

<dt class="hdlist1">Overview</dt>

<dd>

<div id="deployment_strategy_blue_green" class="imageblock">

<div class="content">

<img src="images/ch5/deployment-strategy-blue-green.png" alt="Blue-green deployment">

</div>

<div class="title">Figure 53. Blue-green deployment</div>

</div>

<div class="paragraph">

<p>As shown in <a href="06.html#deployment_strategy_blue_green">Figure 53</a>:</p>

</div>

<div class="olist arabic">

<ol class="arabic">

<li>

<p>You start with several replicas of v1 of your app running. Let&#8217;s refer to these v1 apps as "blue."</p>

</li>

<li>

<p>You start deploying v2 of your app, which we&#8217;ll refer to as "green," onto new servers. The v2 apps start to go

through health checks in the load balancer, but the load balancer does <em>not</em> yet send any traffic to them.</p>

</li>

<li>

<p>When <em>all</em> the v2 replicas are passing health checks, you do an instantaneous switchover, moving all traffic from

v1 (blue) to v2 (green). At that point, you undeploy all the v1 servers, leaving just v2.</p>

</li>

</ol>

</div>

</dd>

<dt class="hdlist1">Advantages</dt>

<dd>

<div class="dlist">

<dl>

<dt class="hdlist1">No downtime</dt>

<dd>

<p>Your app keeps work for your users during deployments.</p>

</dd>

<dt class="hdlist1">Good UX</dt>

<dd>

<p>During a deployment, your users see only one version of the app or the other, but not both, so you avoid

a jarring user experience and potential bugs.</p>

</dd>

</dl>

</div>

</dd>

<dt class="hdlist1">Drawbacks</dt>

<dd>

<div class="dlist">

<dl>

<dt class="hdlist1">Limited support</dt>

<dd>

<p>Only a small subset of tools natively support blue-green deployments.</p>

</dd>

<dt class="hdlist1">Works only with stateless apps</dt>

<dd>

<p>With stateless apps, you typically can&#8217;t instantaneously move data over to the

new version, so blue-green deployments aren&#8217;t an option (without downtime).</p>

</dd>

</dl>

</div>

</dd>

<dt class="hdlist1">Use cases</dt>

<dd>

<div class="dlist">

<dl>

<dt class="hdlist1">Deploying stateless apps</dt>

<dd>

<p>Blue-green deployments are the gold standard for deploying stateless apps.</p>

</dd>

</dl>

</div>

</dd>

</dl>

</div>

</div>

<div class="sect4">

<h4 id="_canary_deployment">Canary deployment</h4>

<div class="paragraph">

<p>This is not a standalone deployment strategy, but a strategy meant to be combined with other strategies, such as

rolling deployment or blue-green deployment, to reduce the risk of broken deployments by testing new code on a single

replica before doing a full rollout.</p>

</div>

<div class="paragraph">

<p>The name canary server here comes from the proverbial "canary in the coal mine," which is a bird that coal miners would

take into mines with them, as canaries are more sensitive to poisonous gasses than humans, so if the canary starts

reacting poorly or dies, it&#8217;s an early warning signal that you need to get out immediately. The idea with canary

deployments is similar: you deploy your new code on solely a single replica initially, and if that replica shows any

problems, you roll back the deployment before it can cause more damage.</p>

</div>

<div class="dlist">

<dl>

<dt class="hdlist1">Overview</dt>

<dd>

<div id="deployment_strategy_canary" class="imageblock">

<div class="content">

<img src="images/ch5/deployment-strategy-canary.png" alt="Canary deployment">

</div>

<div class="title">Figure 54. Canary deployment</div>

</div>

<div class="paragraph">

<p>As shown in <a href="06.html#deployment_strategy_canary">Figure 54</a>:</p>

</div>

<div class="olist arabic">

<ol class="arabic">

<li>

<p>You start with several replicas of v1 of your app running.</p>

</li>

<li>

<p>You deploy a single replica of v2, called the <em>canary server</em>, and send traffic to it. You then compare the canary

server to a randomly-chosen older (v1) server, called the <em>control</em>. If you see any differencese.g., the canary

has higher error rates or higher memory usage than the controlthis gives you an early warning that the deployment has

problems, and you can roll it back before it does too much damage.</p>

</li>

<li>

<p>If you can&#8217;t find any differences between the canary and the control, then you can roll out v2 fully

using one of the other strategies, such as rolling deployment or blue-green deployment.</p>

</li>

</ol>

</div>

</dd>

<dt class="hdlist1">Advantages</dt>

<dd>

<div class="dlist">

<dl>

<dt class="hdlist1">Catch errors early</dt>

<dd>

<p>Before they affect too many of your users.</p>

</dd>

</dl>

</div>

</dd>

<dt class="hdlist1">Drawbacks</dt>

<dd>

<div class="dlist">

<dl>

<dt class="hdlist1">Poor UX</dt>

<dd>

<p>During a canary deployment, a small percentage of your users may see both the old and new versions of

your app at the same time, which can be a jarring user experience, or even cause bugs if you&#8217;re not careful.</p>

</dd>

</dl>

</div>

</dd>

<dt class="hdlist1">Use cases</dt>

<dd>

<div class="dlist">

<dl>

<dt class="hdlist1">Large deployments</dt>

<dd>

<p>Where even a small percentage of traffic can give you meaningful data.</p>

</dd>

<dt class="hdlist1">Risky deployments</dt>

<dd>

<p>Where a full-scale outage would cause significant problems for your business.</p>

</dd>

</dl>

</div>

</dd>

</dl>

</div>

</div>

<div class="sect4">

<h4 id="_feature_toggle_deployment">Feature toggle deployment</h4>

<div class="paragraph">

<p>You saw feature toggles earlier in <a href="06.html#feature_toggles">Section 5.1.3.2</a> as a technique for being able to merge code into <code>main</code>

regularly, even while making large-scale changes. It turns out that feature toggles can also have a profound impact on

how you deploy software, too. This is also not a standalone deployment strategy, but a strategy meant to be combined

with other strategies, such as rolling deployment or blue-green deployment.</p>

</div>

<div class="dlist">

<dl>

<dt class="hdlist1">Overview</dt>

<dd>

<div id="deployment_strategy_feature_toggle" class="imageblock">

<div class="content">

<img src="images/ch5/deployment-strategy-feature-toggle.png" alt="Feature toggle deployment">

</div>

<div class="title">Figure 55. Feature toggle deployment</div>

</div>

<div class="paragraph">

<p>As shown in <a href="06.html#deployment_strategy_canary">Figure 54</a>:</p>

</div>

<div class="olist arabic">

<ol class="arabic">

<li>

<p>You start with several replicas of v1 of your app running.</p>

</li>

<li>

<p>You deploy v2 of your app using one of the other strategies, such as rolling deployments or blue-green

deployments, but with a key difference: any new features in the new version are wrapped in a feature toggleand off

by default. Therefore, the deployment itself doesn&#8217;t release any new functionality: that is, users won&#8217;t see any

differences as a result of v2 being deployed.</p>

</li>

<li>

<p>After the deployment is done, you can then enable v2 using your feature toggle service, and only then will users

start to see different functionality.</p>

</li>

</ol>

</div>

</dd>

<dt class="hdlist1">Advantages</dt>

<dd>

<div class="dlist">

<dl>

<dt class="hdlist1">Separate deployment from release</dt>

<dd>

<p>Without feature toggles, every time you <em>deploy</em> new code (e.g., roll out a new

Docker image into a Kubernetes cluster), you also automatically <em>release</em> every single new feature in that code, all

at once. With feature toggles, the deployment and release steps are now separate, which makes deployments

considerably less risky. This is another one of the key ingredients that makes it possible for the companies with

world-class software delivery processes mentioned in <a href="index.html#world_class_delivery">What world-class software delivery looks like</a> to deploy thousands of times per day.</p>

</dd>

<dt class="hdlist1">Resolve issues without deploying new code</dt>

<dd>

<p>Not only do feature toggles allow you to release features separately

from deploying new code, but they also allow you to <em>unrelease</em> features without code changes. That is, if you

enable a feature toggle, and you start seeing problems (bugs, performance issues, outages), you can just as quickly

disable that feature toggle to turn the feature off. In many cases, this gives you a way to resolve issues that is

much faster than having to write and deploy new code. It&#8217;s one of the big reasons the companies mentioned in

<a href="index.html#world_class_delivery">What world-class software delivery looks like</a> can recover from downtime 170 times faster. If you&#8217;re paged at 3AM because of an outage,

the ability to disable the feature causing the outage in a few clicks, so you can all go back to sleep and put in a

more permanent fix during normal working hours, truly feels like a superpower.</p>

</dd>

<dt class="hdlist1">Ramp new features</dt>

<dd>

<p>A remarkable benefit of separating deployment from release is that it allows you to <em>ramp</em>

features gradually, rather than them being on all at once. For example, at LinkedIn, one of the changes from Project

Inversion was to require all new features to be wrapped in feature toggles, and to ramp them up gradually; Facebook,

Google, and many other companies use similar processes. Every new feature starts off disabled by default, and when

it&#8217;s ready for testing, we&#8217;d first turn it on only for employees, so that we could test it internally; if you work

at companies like LinkedIn, Facebook, or Google, your experience of those products can be very different from that of

the general public. Once things are looking good in internal testing, we could then ramp the feature up, turning it

on for, say, a random 1% of users. We&#8217;d then observe those users, looking at their error rates to make

sure there were no problems. If everything looked OK, we&#8217;d ramp the feature to 10% of users. After another round of

observation, we&#8217;d ramp to 50%, and eventually to 100%. If we hit issues at any point, we could pause the ramp, or

ramp back down.</p>

</dd>

<dt class="hdlist1">A/B test features</dt>

<dd>

<p>One more superpower you get from feature toggles is the ability to do <em>A/B testing</em> (AKA

<em>bucket testing</em>), where you can compare how different versions of your product perform against each other. For example,

you could randomly split your users into two buckets, a bucket A with the new feature enabled, and a bucket B with

the new feature disabled, and compare how the users perform at key metrics across the two buckets. For example, did

the new feature increase engagement? Downloads? Purchases? Referrals? This is just like a scientific experiment, with

control and experimental groups: as long as (a) you randomly assign users to buckets, (b) the only difference between

the buckets is the new feature, and (c) you gather enough data for it to be statistically significant,<sup class="footnote">[<a id="_footnoteref_39" class="footnote" href="13-footnotes.html#_footnotedef_39" title="View footnote.">39</a>]</sup> then you can be reasonably confident that any difference in metrics between the

buckets is due to the new feature. In other words, you are using data to establish a causal relationship!</p>

<div class="paragraph">

<p>This is sometimes called <em>data-driven product development</em>, and if you have the type of product where you can do it

(i.e., you can show users different versions of the product, and you have sufficient traffic to generate statistically

significant results), it can be transformational.<sup class="footnote">[<a id="_footnoteref_40" class="footnote" href="13-footnotes.html#_footnotedef_40" title="View footnote.">40</a>]</sup></p>

</div>

</dd>

</dl>

</div>

</dd>

<dt class="hdlist1">Drawbacks</dt>

<dd>

<div class="dlist">

<dl>

<dt class="hdlist1">Requires an extra service</dt>

<dd>

<p>To use feature toggles, you have to run and maintain an extra feature toggle service,

or pay for one from a 3rd party.</p>

</dd>

<dt class="hdlist1">Forked code</dt>

<dd>

<p>Over time, as you add more and more if-statements with feature toggle lookups, you get more and more

forks in your code. This makes the code harder to maintain and test. If you&#8217;re going to use feature toggles, you&#8217;ll

need to create the discipline (and automation) to ensure that you systematically remove if-statements for feature

toggles that are unlikely to ever change again (e.g., feature toggles greater than 1 year old).</p>

</dd>

</dl>

</div>

</dd>

<dt class="hdlist1">Use cases</dt>

<dd>

<div class="dlist">

<dl>

<dt class="hdlist1">All new feature development</dt>

<dd>

<p>The ability to separate deployment from release, carefully ramp new features, and

quickly shut off features that are causing issues is such a huge advantage in agility, that once you get past a

certain scale as a company, you should consider wrapping all new features in feature toggles.</p>

</dd>

<dt class="hdlist1">Data-driven development</dt>

<dd>

<p>Feature toggles are an incredibly powerful tool for product teams, as they give you the

ability to do A/B testing and data-driven development.</p>

</dd>

</dl>

</div>

</dd>

</dl>

</div>

</div>

<div class="sect4">

<h4 id="_promotion_deployment">Promotion deployment</h4>

<div class="paragraph">

<p>This is yet another strategy that isn&#8217;t a standalone strategy, but meant to be combined with other strategies, such

as rolling deployment or blue-green deployment. The idea with <em>promotion deployments</em> (AKA <em>promotion workflows</em>) is to

deploy your code across multiple environments, starting with internal pre-production environments, and ending up in your

production environment, with the hope that you can catch issues in the pre-production environments before they affect

production (you&#8217;ll learn more about multiple environments in <a href="09.html#how_to_work_with_multiple_teams">Part 8</a>).</p>

</div>

<div class="dlist">

<dl>

<dt class="hdlist1">Overview</dt>

<dd>

<div id="deployment_strategy_promotion" class="imageblock">

<div class="content">

<img src="images/ch5/deployment-strategy-promotion.png" alt="Promotion deployment">

</div>

<div class="title">Figure 56. Promotion deployment</div>

</div>

<div class="paragraph">

<p>As shown in <a href="06.html#deployment_strategy_promotion">Figure 56</a>:</p>

</div>

<div class="olist arabic">

<ol class="arabic">

<li>

<p>Let&#8217;s say you have three environments: dev, stage, and prod. Initially, v1 of your app is running in all three of

those environments.</p>

</li>

<li>

<p>You use one of the other deployment strategies (e.g., rolling deployment or blue-green deployment) to deploy v2 across

the dev environment, and do a round of testing in dev.</p>

</li>

<li>

<p>If everything works well in dev, you deploy <em>exactly</em> the same v2 codealso known as <em>promoting</em> v2to the stage

environment, and do a round of testing in stage.</p>

</li>

<li>

<p>If everything works well in stage, you finally promote v2 to prod.</p>

</li>

</ol>

</div>

</dd>

<dt class="hdlist1">Advantages</dt>

<dd>

<div class="dlist">

<dl>

<dt class="hdlist1">Multiple chances to catch errors</dt>

<dd>

<p>You get a chance to test your code in pre-prod environments before that exact

same code goes to prod.</p>

</dd>

</dl>

</div>

</dd>

<dt class="hdlist1">Drawbacks</dt>

<dd>

<div class="dlist">

<dl>

<dt class="hdlist1">Requires multiple environments</dt>

<dd>

<p>You have to deploy and maintain multiple environments, instead of just one.</p>

</dd>

</dl>

</div>

</dd>

<dt class="hdlist1">Use cases</dt>

<dd>

<div class="dlist">

<dl>

<dt class="hdlist1">All deployments</dt>

<dd>

<p>The benefits of having pre-prod environments to test in are so significant, that once you get

past a certain scale as a company, you should consider using multiple environments and promotion workflows for all

deployments.</p>

</dd>

</dl>

</div>

</dd>

</dl>

</div>

</div>

<div class="sect4">

<h4 id="_infrastructure_deployment">Infrastructure deployment</h4>

<div class="paragraph">

<p>Except for promotion workflows, just about all the deployment strategies in the previous sections are

only applicable to deploying <em>application code</em>: e.g., apps written in Java, Ruby, Python, JavaScript, etc. When it

comes to <em>infrastructure code</em> (e.g., OpenTofu, Pulumi, CloudFormation), the deployment strategies that are available

are much more limited. Typically, it&#8217;s binary: either you make an infrastructure change, or you don&#8217;t; either you

create (or delete!) that database, or you don&#8217;t; there&#8217;s no gradual rollout, no feature toggles, no canaries, etc. That

makes infrastructure deployments harder and riskier. In this section, I&#8217;ll describe the typical strategy used to

mitigate those risks.</p>

</div>

<div class="dlist">

<dl>

<dt class="hdlist1">Overview</dt>

<dd>

<p>Most infrastructure deployments come down to combining two strategies:</p>

<div class="dlist">

<dl>

<dt class="hdlist1">Validate plan output</dt>

<dd>

<p>Assuming your infrastructure tool supports some sort of plan or dry-run operation, you should

always analyze the plan output before deploying changes to an environment. For example, with OpenTofu, you can

integrate running the <code>plan</code> command into your pull request workflow, so you can review not only the code changes,

but also the plan output, before merging changes in. You&#8217;ll see an example of this later in this

blog post.</p>

</dd>

<dt class="hdlist1">Use a promotion workflow</dt>

<dd>

<p>Promote infrastructure changes from environment to environment, just as you saw in the

previous section. For example, you deploy the same infrastructure code first in dev, then in stage, and then in prod,

with a period of testing in each environment before moving onto the next one.</p>

</dd>

</dl>

</div>

</dd>

<dt class="hdlist1">Advantages</dt>

<dd>

<div class="dlist">

<dl>

<dt class="hdlist1">Works with infrastructure deployments</dt>

<dd>

<p>The strategies in this section work with most types of infrastructure

changes.</p>

</dd>

<dt class="hdlist1">Even more chances to catch errors</dt>

<dd>

<p>You not only get a chance to test your code in pre-prod environments before

that exact same code goes to prod, but you also get to check the plan output for each environment before deploying

code into that environment.</p>

</dd>

</dl>

</div>

</dd>

<dt class="hdlist1">Drawbacks</dt>

<dd>

<div class="dlist">

<dl>

<dt class="hdlist1">Requires multiple environments</dt>

<dd>

<p>You have to deploy and maintain multiple environments, instead of just one.</p>

</dd>

</dl>

</div>

</dd>

<dt class="hdlist1">Use cases</dt>

<dd>

<div class="dlist">

<dl>

<dt class="hdlist1">All infrastructure deployments</dt>

<dd>

<p>The benefits of having both plan output before a deployment to an environment,

and having pre-prod environments to test in before prod, are so significant, that once you get past a certain scale

as a company, you should consider using this approach for all infrastructure deployments.</p>

</dd>

</dl>

</div>

</dd>

</dl>

</div>

</div>

</div>

<div class="sect3">

<h3 id="_deployment_pipelines">Deployment pipelines</h3>

<div class="paragraph">

<p>A <em>deployment pipeline</em> is the process you use to go from an idea to live code that affects your users. It consists of

all the steps you must go through on the way to release. Deployment pipelines are different at every company, as they

are effectively capturing your company&#8217;s processes, policies, and requirements as code, but most pipelines include the

following:</p>

</div>

<div class="dlist">

<dl>

<dt class="hdlist1">Commit</dt>

<dd>

<p>How do you get code into version control? Do you use a pull-request based process? Do you use

trunk-based development?</p>

</dd>

<dt class="hdlist1">Build</dt>

<dd>

<p>What compilation and build steps do you need? How do you package the code?</p>

</dd>

<dt class="hdlist1">Test</dt>

<dd>

<p>What automated tests do you run against the code? What manual tests?</p>

</dd>

<dt class="hdlist1">Review</dt>

<dd>

<p>What review processes do you use? Who has to sign off and approve merges and deployments?</p>

</dd>

<dt class="hdlist1">Deploy</dt>

<dd>

<p>How do you get the new code into production? How do you release new functionality to users?</p>

</dd>

</dl>

</div>

<div class="paragraph">

<p>Typically, you run a deployment pipeline on a <em>deployment server</em>, and not a developer&#8217;s computer (you&#8217;ll see later in

this blog post why). The most common option is to use the same server you use for CI, such as the ones

you saw earlier in the post (e.g., <a href="https://github.com/features/actions">GitHub Actions</a>,

<a href="https://circleci.com/">CircleCi</a>, and <a href="https://about.gitlab.com/">GitLab</a>). Another option is to use deployment servers

that are designed for a specific technology: for example, for OpenTofu and Terraform, you might use the

<a href="https://www.hashicorp.com/cloud">HashiCorp Cloud Platform</a>), <a href="https://www.env0.com/">env0</a>,

<a href="https://www.scalr.com/">Scalr</a>, <a href="https://spacelift.io/">Spacelift</a>, or <a href="https://www.runatlantis.io/">Atlantis</a>.</p>

</div>

<div class="paragraph">

<p>You also need to pick a language for defining your pipeline as code. Again, the most common option is to use the

workflow definition language that comes with your CI server: e.g.,

<a href="https://docs.github.com/en/actions/using-workflows/about-workflows">GitHub Actions workflows</a> are defined in YAML.

Other options include defining workflows in scripting languages (e.g., Ruby, Python, Bash), your build system&#8217;s language

(e.g., NPM, Maven, Make), and, a relatively recent option is to use a tool designed for defining workflows that can

run on a variety of platforms, such as <a href="https://dagger.io/">Dagger</a> or

<a href="https://www.commonwl.org/">Common Workflow Language</a>. In many cases, a deployment pipeline will use multiple languages

and tools together.</p>

</div>

<div class="paragraph">

<p>The best way to understand deployment pipelines is to see an example, which is the focus of the next several sections.

After that, you&#8217;ll learn about deployment pipeline best practices that apply to any company and any pipeline.</p>

</div>

<div class="sect4">

<h4 id="_example_configure_an_automated_deployment_pipeline_in_github_actions">Example: configure an automated deployment pipeline in GitHub Actions</h4>

<div class="paragraph">

<p>To avoid introducing too many new tools, let&#8217;s stick use GitHub Actions as the deployment server and GitHub Actions

YAML workflows as the primary language for defining the pipeline. The goal is to implement the following pipeline for

the <code>lambda-sample</code> module:</p>

</div>

<div id="example_deployment_pipeline" class="imageblock">

<div class="content">

<img src="images/ch5/deployment-pipeline.png" alt="The steps of a typical deployment pipeline (left) and the example technologies you&#8217;ll use (right)">

</div>

<div class="title">Figure 57. The steps of a typical deployment pipeline (left) and the example technologies you&#8217;ll use (right)</div>

</div>

<div class="paragraph">

<p>Here&#8217;s how this pipeline works:</p>

</div>

<div class="olist arabic">

<ol class="arabic">

<li>

<p><strong>Commit code to a branch in your VCS</strong>: The first step is to make some code changes in a branch.</p>

</li>

<li>

<p><strong>Open a pull request</strong>: Once the changes are ready to review, you open a PR.</p>

</li>

<li>

<p><strong>Run automations for open pull request</strong>: Your deployment server runs automations on the open PR, such as

compiling the code, static analysis, functional tests (e.g., unit tests, integration tests, etc.), and generating

the plan output by running <code>tofu plan</code>.</p>

</li>

<li>

<p><strong>Review and merge the pull request</strong>: Your team members review the PR, plus the outputs of the automations (e.g., test

results, plan output), and if everything looks good, merge the PR in.</p>

</li>

<li>

<p><strong>Run automations for the merged pull request</strong>: Finally, your deployment server runs automations for the merged

PR, such as compiling the code, static analysis, functional tests, and lastly, deploying the changes by running

<code>tofu apply</code>.</p>

</li>

</ol>

</div>

<div class="paragraph">

<p>This type of pipeline, where you mostly drive actions through operations in Git (e.g., commits, branches, and pull

requests) is often referred to as a <em>GitOps pipeline</em>. As it turns out, you&#8217;ve implemented most of this GitOps pipeline

in this blog post already, as part of setting up automated tests in the CI section. The only items

missing are the following:</p>

</div>

<div class="ulist">

<ul>

<li>

<p>When you open a PR, run <code>plan</code> on the <code>lambda-sample</code> module.</p>

</li>

<li>

<p>When you merge a PR, run <code>apply</code> on the <code>lambda-sample</code> module.</p>

</li>

</ul>

</div>

<div class="paragraph">

<p>To add these items, you need to do the following steps:</p>

</div>

<div class="ulist">

<ul>

<li>

<p>Use a remote backend for OpenTofu state</p>

</li>

<li>

<p>Add IAM roles for infrastructure deployments in GitHub Actions</p>

</li>

<li>

<p>Define a pipeline for infrastructure deployments</p>

</li>

</ul>

</div>

<div class="paragraph">

<p>The following three sections will cover each of these steps.</p>

</div>

</div>

<div class="sect4">

<h4 id="_example_use_a_remote_backend_for_opentofu_state">Example: use a remote backend for OpenTofu state</h4>

<div class="paragraph">

<p>In <a href="03.html#example_deploy_update_destroy_opentofu">Section 2.3.5.2</a>, you learned that, by default, OpenTofu uses the local backend to store

OpenTofu state in <em>.tfstate</em> files on your local hard drive. This works fine when you&#8217;re learning and working alone,

but if you want to use OpenTofu as a team, you need a way to share these state files. You might be tempted to use

version control, but that&#8217;s not a good idea for the following reasons:</p>

</div>

<div class="dlist">

<dl>

<dt class="hdlist1">Manual error</dt>

<dd>

<p>It&#8217;s too easy to forget to pull down the latest changes from version control before running OpenTofu or to push

your latest changes to version control after running OpenTofu. It&#8217;s just a matter of time before someone on your

team runs OpenTofu with out-of-date state files and, as a result, accidentally rolls back or duplicates previous

deployments.</p>

</dd>

<dt class="hdlist1">Locking</dt>

<dd>

<p>Most version control systems do not provide any form of locking that would prevent two team members from running

<code>tofu apply</code> on the same state file at the same time.</p>

</dd>

<dt class="hdlist1">Secrets</dt>

<dd>

<p>All data in OpenTofu state files is stored in plain text. This is a problem because certain OpenTofu resources need

to store sensitive data. For example, if you use the <code>aws_db_instance</code> resource to create a database, OpenTofu will

store the username and password for the database in a state file in plain text, and you shouldn&#8217;t store plain text

secrets in version control (something you&#8217;ll learn more about in <a href="08.html#how_to_manage_auth_and_secrets">Part 7</a>).</p>

</dd>

</dl>

</div>

<div class="paragraph">

<p>This is why in <a href="05.html#how_to_version_build_test">Part 4</a>, you added <em>.tfstate</em> files to <em>.gitignore</em>, so as not to accidentally

check them in.</p>

</div>

<div class="paragraph">

<p>Instead of using version control, the best way to share state files in a team is to use a supported <em>remote backend</em>,

such as Amazon Storage Service (S3), Azure Storage, Google Cloud Storage (GCS), Consul, or Postgres. Remote backends

solve the three issues just listed:</p>

</div>

<div class="dlist">

<dl>

<dt class="hdlist1">Manual error</dt>

<dd>

<p>After you configure a remote backend, OpenTofu will automatically load the state file from that backend every time

you run <code>plan</code> or <code>apply</code>, and it&#8217;ll automatically store the state file in that backend after each <code>apply</code>, so there&#8217;s

no chance of manual error.</p>

</dd>

<dt class="hdlist1">Locking</dt>

<dd>

<p>Most of the remote backends natively support locking. To run <code>tofu apply</code>, OpenTofu will automatically acquire a

lock; if someone else is already running <code>apply</code>, they will already have the lock, and you will have to wait. You can

run <code>apply</code> with the <code>-lock-timeout=&lt;TIME&gt;</code> parameter to instruct OpenTofu to wait up to <code>TIME</code> for a lock to be

released (e.g., <code>-lock-timeout=10m</code> will wait for 10 minutes).</p>

</dd>

<dt class="hdlist1">Secrets</dt>

<dd>

<p>Most of the remote backends natively support encryption in transit and encryption at rest of the state file.

Moreover, those backends usually expose ways to configure access permissions, so you can control who has access to

your state files and the secrets they might contain.</p>

</dd>

</dl>

</div>

<div class="paragraph">

<p>If you&#8217;re using OpenTofu with AWS, Amazon&#8217;s managed file store, S3, is typically your best bet as a remote backend for

the following reasons:</p>

</div>

<div class="ulist">

<ul>

<li>

<p>It&#8217;s a managed service, so you don&#8217;t need to deploy and manage extra infrastructure to use it.</p>

</li>

<li>

<p>It&#8217;s designed for 99.999999999% durability and 99.99% availability, which means you don&#8217;t need to worry too much

about data loss or outages.<sup class="footnote">[<a id="_footnoteref_41" class="footnote" href="13-footnotes.html#_footnotedef_41" title="View footnote.">41</a>]</sup></p>

</li>

<li>

<p>It supports encryption, which reduces worries about storing sensitive data in state files.</p>

</li>

<li>

<p>It supports locking via DynamoDB (more on this shortly).</p>

</li>

<li>

<p>It supports <em>versioning</em>, so every revision of your state file is stored, and you can roll back to an older version

if something goes wrong.</p>

</li>

<li>

<p>It&#8217;s inexpensive, with most OpenTofu usage easily fitting into the AWS Free Tier.<sup class="footnote">[<a id="_footnoteref_42" class="footnote" href="13-footnotes.html#_footnotedef_42" title="View footnote.">42</a>]</sup></p>

</li>

</ul>

</div>

<div class="paragraph">

<p>To enable remote state storage with Amazon S3, you must first create an S3 bucket and DynamoDB table. The

blog post series&#8217;s sample code repo includes a module called <code>state-bucket</code> in the <em>ch5/tofu/modules/state-bucket</em>

folder which can create an S3 bucket to store OpenTofu state, including:</p>

</div>

<div class="ulist">

<ul>

<li>

<p>Enabling versioning on the S3 bucket so that every update to a file in the bucket actually creates a new version of

that file. This allows you to see older versions of the file and revert to those older versions at any time, which

can be a useful fallback mechanism if something goes wrong.</p>

</li>

<li>

<p>Turning server-side encryption on by default for all data written to the S3 bucket. This ensures that your state

files, and any secrets they might contain, are always encrypted on disk when stored in S3.</p>

</li>

<li>

<p>Blocking all public access to the S3 bucket. S3 buckets are private by default, but as they are often used to serve

static contente.g., images, fonts, CSS, JS, HTMLit is possible, even easy, to make the buckets public. Since your

state files may contain sensitive data and secrets, it&#8217;s worth adding this extra layer of protection to ensure no

one on your team can ever accidentally make this S3 bucket public.</p>

</li>

</ul>

</div>

<div class="paragraph">

<p>The <code>state-bucket</code> module can also create a DynamoDB table for OpenTofu locking. DynamoDB is Amazon&#8217;s distributed

key-value store. It supports strongly consistent reads and conditional writes, which are all the ingredients you need

for a distributed lock system. Moreover, it&#8217;s completely managed, so you don&#8217;t have any infrastructure to run yourself,

and it&#8217;s inexpensive, with most OpenTofu usage easily fitting into the AWS Free Tier.<sup class="footnote">[<a id="_footnoteref_43" class="footnote" href="13-footnotes.html#_footnotedef_43" title="View footnote.">43</a>]</sup></p>

</div>

<div class="paragraph">

<p>To use the <code>state-bucket</code> module, first check out the <code>main</code> branch of your own repo, and make sure you have the latest

code:</p>

</div>

<div class="listingblock">

<div class="content">

<pre>$ cd fundamentals-of-devops

$ git checkout main

$ git pull origin main</pre>

</div>

</div>

<div class="paragraph">

<p>Next, create a new folder called <em>tofu-state</em> to use as a root module:</p>

</div>

<div class="listingblock">

<div class="content">

<pre>$ mkdir -p ch5/tofu/live/tofu-state

$ cd ch5/tofu/live/tofu-state</pre>

</div>

</div>

<div class="paragraph">

<p>Within the <em>tofu-state</em> folder, create a <em>main.tf</em> file with the contents shown in <a href="06.html#tofu_state_bucket_s3">Example 100</a>:</p>

</div>

<div id="tofu_state_bucket_s3" class="exampleblock">

<div class="title">Example 100. Configure the <code>state-bucket</code> module (<em>ch5/tofu/live/tofu-state/main.tf</em>)</div>

<div class="content">

<div class="listingblock">

<div class="content">

<pre class="CodeRay highlight"><code data-lang="terraform">provider &quot;aws&quot; {

  region = &quot;us-east-2&quot;

}



module &quot;state&quot; {

  source = &quot;github.com/brikis98/fundamentals-of-devops-code//ch5/tofu/modules/state-bucket&quot;



  # TODO: fill in your own bucket name!

  name = &quot;fundamentals-of-devops-tofu-state&quot;

}</code></pre>

</div>

</div>

</div>

</div>

<div class="paragraph">

<p>This code sets just one parameter, <code>name</code>, which will be used as the name of the S3 bucket and DynamoDB table. Note

that S3 bucket names must be <em>globally</em> unique among all AWS customers. Therefore, you <em>must</em> change the <code>name</code>

parameter from <code>"fundamentals-of-devops-tofu-state"</code> (which I already created) to your own name. Make sure to remember

this name and take note of what AWS region you&#8217;re using because you&#8217;ll need both pieces of information again a little

later on.</p>

</div>

<div class="paragraph">

<p>To create the S3 bucket and DynamoDB table, run <code>init</code> and <code>apply</code> as usual:</p>

</div>

<div class="listingblock">

<div class="content">

<pre>$ tofu init

$ tofu apply</pre>

</div>

</div>

<div class="paragraph">

<p>Once <code>apply</code> is done, you can start using the S3 bucket and DynamoDB table for state storage. To do that, you need to

update your OpenTofu modules with a <code>backend</code> configuration. As a first step, add a <em>backend.tf</em> file to the

<code>tofu-state</code> module with the contents shown in <a href="06.html#tofu_state_bucket_backend">Example 101</a>:</p>

</div>

<div id="tofu_state_bucket_backend" class="exampleblock">

<div class="title">Example 101. OpenTofu code to use an S3 bucket and DynamoDB table as a backend (<em>ch5/tofu/live/tofu-state/backend.tf</em>)</div>

<div class="content">

<div class="listingblock">

<div class="content">

<pre class="CodeRay highlight"><code data-lang="terraform">terraform {

  backend &quot;s3&quot; {

    # TODO: fill in your own bucket name here!

    bucket         = &quot;fundamentals-of-devops-tofu-state&quot; # <b class="conum">(1)</b>

    key            = &quot;ch5/tofu/live/tofu-state&quot;          # <b class="conum">(2)</b>

    region         = &quot;us-east-2&quot;                         # <b class="conum">(3)</b>

    encrypt        = true                                # <b class="conum">(4)</b>

    # TODO: fill in your own DynamoDB table name here!

    dynamodb_table = &quot;fundamentals-of-devops-tofu-state&quot; # <b class="conum">(5)</b>

  }

}</code></pre>

</div>

</div>

</div>

</div>

<div class="paragraph">

<p>Here&#8217;s what this code does:</p>

</div>

<div class="colist arabic">

<ol>

<li>

<p>Configure the S3 bucket to use as a remote backend. Make sure to fill in your own S3 bucket&#8217;s name here.</p>

</li>

<li>

<p>The filepath within the S3 bucket where the OpenTofu state file should be written. You can use a single S3 bucket

and DynamoDB table to store the state file for many different modules so long as you ensure that each module gets

a unique <code>key</code> (filepath) for its state file.</p>

</li>

<li>

<p>The AWS region where you created your S3 bucket.</p>

</li>

<li>

<p>Setting <code>encrypt</code> to <code>true</code> ensures that your OpenTofu state will be encrypted on disk when stored in S3. You

already enabled default encryption in the S3 bucket itself, so this is here as a second layer to ensure that the

data is always encrypted.</p>

</li>

<li>

<p>The DynamoDB table to use for locking. Make sure to fill in your own DynamoDB table&#8217;s name here.</p>

</li>

</ol>

</div>

<div class="paragraph">

<p>Run <code>tofu init</code> one more time, and you should see something like this:</p>

</div>

<div class="listingblock">

<div class="content">

<pre>$ tofu init



Initializing the backend...

Do you want to copy existing state to the new backend?

  Pre-existing state was found while migrating the previous "local" backend to the

  newly configured "s3" backend. No existing state was found in the newly

  configured "s3" backend. Do you want to copy this state to the new "s3"

  backend? Enter "yes" to copy and "no" to start with an empty state.



  Enter a value:</pre>

</div>

</div>

<div class="paragraph">

<p>OpenTofu will automatically detect that you already have a state file locally and prompt you to copy it to the new S3

backend. If you type <strong><code>yes</code></strong> and hit ENTER, you should see the following:</p>

</div>

<div class="listingblock">

<div class="content">

<pre>Successfully configured the backend "s3"! OpenTofu will automatically

use this backend unless the backend configuration changes.</pre>

</div>

</div>

<div class="paragraph">

<p>With this backend enabled, OpenTofu will automatically pull the latest state from this S3 bucket before running a

command and automatically push the latest state to the S3 bucket after running a command, and it&#8217;ll use DynamoDB locks

to handle concurrent access.</p>

</div>

<div class="paragraph">

<p>You should make the same change in the <code>lambda-sample</code> module as well, adding the <em>backend.tf</em> file shown in

<a href="06.html#tofu_state_lambda_backend">Example 102</a>:</p>

</div>

<div id="tofu_state_lambda_backend" class="exampleblock">

<div class="title">Example 102. Update the <code>lambda-sample</code> module to use S3 as a backend (<em>ch5/tofu/live/lambda-sample/backend.tf</em>)</div>

<div class="content">

<div class="listingblock">

<div class="content">

<pre class="CodeRay highlight"><code data-lang="terraform">terraform {

  backend &quot;s3&quot; {

    # TODO: fill in your own bucket name here!

    bucket         = &quot;fundamentals-of-devops-tofu-state&quot; # <b class="conum">(1)</b>

    key            = &quot;ch5/tofu/live/lambda-sample&quot;       # <b class="conum">(2)</b>

    region         = &quot;us-east-2&quot;

    encrypt        = true

    # TODO: fill in your own DynamoDB table name here!

    dynamodb_table = &quot;fundamentals-of-devops-tofu-state&quot; # <b class="conum">(3)</b>

  }

}</code></pre>

</div>

</div>

</div>

</div>

<div class="paragraph">

<p>This is identical to the <em>backend.tf</em> in the <code>tofu-state</code> module, but note three things:</p>

</div>

<div class="colist arabic">

<ol>

<li>

<p>Just as in the <code>tofu-state</code> module, you&#8217;ll need to fill in the name of your own S3 bucket here.</p>

</li>

<li>

<p>The <code>key</code> value for the <code>lambda-sample</code> module <em>must</em> be different than the <code>tofu-state</code> module, so they don&#8217;t

overwrite each other&#8217;s state!</p>

</li>

<li>

<p>Just as in the <code>tofu-state</code> module, you&#8217;ll need to fill in the name of your own DynamoDB table here.</p>

</li>

</ol>

</div>

<div class="admonitionblock tip">

<table>

<tr>

<td class="icon">

<div class="title">Tip</div>

</td>

<td class="content">

<div class="title">Get your hands dirty: reduce duplication in the <code>backend</code> config</div>

<div class="paragraph">

<p>If you&#8217;re like me, you&#8217;re probably annoyed by all the copy/paste you need to do with these <code>backend</code> configurations.

Unfortunately, OpenTofu does not support using variables or any other kind of logic in <code>backend</code> blocks, so some amount

of copy/paste is necessary. However, you can try out one of the following approaches to significantly reduce the code

duplication:</p>

</div>

<div class="ulist">

<ul>

<li>

<p><a href="https://opentofu.org/docs/language/settings/backends/configuration/#partial-configuration">Partial backend configuration</a></p>

</li>

<li>

<p><a href="https://terragrunt.gruntwork.io/">Terragrunt</a></p>

</li>

</ul>

</div>

</td>

</tr>

</table>

</div>

<div class="paragraph">

<p>To finish up the remote state setup, do the following two steps:</p>

</div>

<div class="olist arabic">

<ol class="arabic">

<li>

<p>Run <code>init</code> on the <code>lambda-sample</code> module to set up remote state storage, just as you did with the <code>tofu-state</code> module.</p>

</li>

<li>

<p>Commit your changes to the <code>lambda-sample</code> and <code>tofu-state</code> modules and push them to <code>main</code>.</p>

</li>

</ol>

</div>

</div>

<div class="sect4">

<h4 id="_example_add_iam_roles_for_infrastructure_deployments_in_github_actions">Example: add IAM roles for infrastructure deployments in GitHub Actions</h4>

<div class="paragraph">

<p>Earlier in this blog post, you configured an OIDC provider to give GitHub Actions access to your AWS

account for running automated tests. Now you need a way to give GitHub Actions access to your AWS account for

deployments. Normally, you would deploy to a totally separate environment (separate AWS account) from where you run

automated tests, so you&#8217;d need to configure a new OIDC provider in your deployment environment. However, to keep things

simple in this post, let&#8217;s use the same AWS account for both deployment and testing (you&#8217;ll

learn how to set up additional environments in <a href="09.html#how_to_work_with_multiple_teams">Part 8</a>). That allows you to use the same

OIDC provider; however, you still need to create new IAM roles for the following reasons:</p>

</div>

<div class="ulist">

<ul>

<li>

<p>The permissions you need for automated tests are different than those for deployment.</p>

</li>

<li>

<p>The permissions for deployment should be managed via two separate IAM roles: one for <code>plan</code> and one for <code>apply</code>.

That&#8217;s because you want <code>plan</code> to run on any branch <em>before</em> a PR has merged, whereas you want <code>apply</code> only to run

on <code>main</code> <em>after</em> a PR has merged. Since the <code>plan</code> portion runs before mergebefore anyone has had a chance to

review the code changesthe IAM role you use for <code>plan</code> should be limited to read-only permissions: enough to see the

<code>plan</code> output, but not enough to make any changes.</p>

</li>

</ul>

</div>

<div class="paragraph">

<p>Open up <em>main.tf</em> in the <code>ci-cd-permissions</code> module and add the code shown in <a href="06.html#tofu_oidc_iam_role_plan">Example 103</a> to enable

creating IAM roles for both <code>plan</code> and <code>apply</code>:</p>

</div>

<div id="tofu_oidc_iam_role_plan" class="exampleblock">

<div class="title">Example 103. Update the <code>ci-cd-permissions</code> module to enable IAM roles for <code>plan</code> and <code>apply</code> (<em>ch5/tofu/live/ci-cd-permissions/main.tf</em>)</div>

<div class="content">

<div class="listingblock">

<div class="content">

<pre class="CodeRay highlight"><code data-lang="terraform">module &quot;iam_roles&quot; {



  # ... (other params omitted) ...



  enable_iam_role_for_plan  = true                                # <b class="conum">(1)</b>

  enable_iam_role_for_apply = true                                # <b class="conum">(2)</b>



  # TODO: fill in your own bucket and table name here!

  tofu_state_bucket         = &quot;fundamentals-of-devops-tofu-state&quot; # <b class="conum">(3)</b>

  tofu_state_dynamodb_table = &quot;fundamentals-of-devops-tofu-state&quot; # <b class="conum">(4)</b>

}</code></pre>

</div>

</div>

</div>

</div>

<div class="paragraph">

<p>This code does the following:</p>

</div>

<div class="colist arabic">

<ol>

<li>

<p>Enable the IAM role for <code>plan</code>. This IAM role will get read-only permissions. The OIDC provider will be allowed to

assume this role from any branch.</p>

</li>

<li>

<p>Enable the IAM role for <code>apply</code>. This IAM role will get both read and write permissions. The OIDC provider will

only be allowed to assume this role from the <code>main</code> branch. This ensures that only merged PRs can be deployed.</p>

</li>

<li>

<p>Configure which S3 bucket to use for Tofu state. Make sure to fill in your own S3 bucket&#8217;s name here. The <code>plan</code>

role will get read-only access to this bucket; the <code>apply</code> role will get read and write access.</p>

</li>

<li>

<p>Configure which DynamoDB table to use for Tofu state. Make sure to fill in your own DynamoDB table&#8217;s name here.

The <code>plan</code> role will get read-only access to this table; the <code>apply</code> role will get read and write access.</p>

</li>

</ol>

</div>

<div class="paragraph">

<p>Next, update <em>outputs.tf</em> with two new output variables that contain the ARNs of the two new IAM roles, as shown in

<a href="06.html#tofu_oidc_iam_role_new_outputs">Example 104</a>:</p>

</div>

<div id="tofu_oidc_iam_role_new_outputs" class="exampleblock">

<div class="title">Example 104. Add output variables for the two new IAM roles (<em>ch5/tofu/live/ci-cd-permissions/outputs.tf</em>)</div>

<div class="content">

<div class="listingblock">

<div class="content">

<pre class="CodeRay highlight"><code data-lang="terraform">output &quot;lambda_deploy_plan_role_arn&quot; {

  value = module.iam_roles.lambda_deploy_plan_role_arn

}



output &quot;lambda_deploy_apply_role_arn&quot; {

  value = module.iam_roles.lambda_deploy_apply_role_arn

}</code></pre>

</div>

</div>

</div>

</div>

<div class="paragraph">

<p>Run <code>apply</code> to create the new IAM roles and take note of the <code>lambda_deploy_plan_role_arn</code> and

<code>lambda_deploy_apply_role_arn</code> outputs; you&#8217;ll need them shortly!</p>

</div>

<div class="paragraph">

<p>Commit your changes to the <code>ci-cd-permissions</code> module and push them to <code>main</code>. You&#8217;re now finally ready to define the

deployment pipeline itself!</p>

</div>

<div class="admonitionblock tip">

<table>

<tr>

<td class="icon">

<div class="title">Tip</div>

</td>

<td class="content">

<div class="title">Get your hands dirty</div>

<div class="paragraph">

<p>Here are a few exercises you can try at home to get a better feel for IAM roles:</p>

</div>

<div class="ulist">

<ul>

<li>

<p>Open up the code for the <code>gh-actions-iam-roles</code> module and read through it. What permissions, exactly, is the

module granting to those IAM roles? Why?</p>

</li>

<li>

<p>Create your own version of the <code>gh-actions-iam-roles</code> module that you can use for deploying other types of

infrastructure, and not just Lambda functions: e.g., try to create IAM roles for deploying EKS clusters, EC2

instances, and so on.</p>

</li>

</ul>

</div>

</td>

</tr>

</table>

</div>

</div>

<div class="sect4">

<h4 id="_example_define_a_pipeline_for_infrastructure_deployments">Example: define a pipeline for infrastructure deployments</h4>

<div class="paragraph">

<p>With all the prerequisites out of the way, you can finally implement a deployment pipeline for the <code>lambda-sample</code> module that

will do the following:</p>

</div>

<div class="ulist">

<ul>

<li>

<p>When you open a PR, run <code>plan</code> on the <code>lambda-sample</code> module.</p>

</li>

<li>

<p>When you merge a PR, run <code>apply</code> on the <code>lambda-sample</code> module.</p>

</li>

</ul>

</div>

<div class="admonitionblock warning">

<table>

<tr>

<td class="icon">

<div class="title">Warning</div>

</td>

<td class="content">

<div class="title">This is a very simplified pipeline (watch out for snakes!)</div>

<div class="paragraph">

<p>The pipeline described here represents only a small piece of a real-world deployment pipeline.<sup class="footnote">[<a id="_footnoteref_44" class="footnote" href="13-footnotes.html#_footnotedef_44" title="View footnote.">44</a>]</sup> It&#8217;s missing several important aspects, including:</p>

</div>

<div class="dlist">

<dl>

<dt class="hdlist1">App build</dt>

<dd>

<p>The <code>lambda-sample</code> module contains a <em>source</em> folder with a dirt-simple "Hello, World" app that doesn&#8217;t

have any dependencies, tests, etc. In real-world deployment pipelines, you usually need to include

steps to build the app, including compiling the code, running tests, packaging the app (e.g., as a Docker image),

packaging static assets (e.g., minification, fingerprinting, etc.) and so on.</p>

</dd>

<dt class="hdlist1">Multiple environments</dt>

<dd>

<p>In this blog post, you&#8217;ll be deploying the <code>lambda-sample</code> module into a single

test account. In real-world usage, your deployment pipeline usually needs to support multiple environments (e.g.,

dev, stage, prod), and the ability to promote changes from one environment to the next. You&#8217;ll learn more about this

in <a href="09.html#how_to_work_with_multiple_teams">Part 8</a>.</p>

</dd>

<dt class="hdlist1">Security</dt>

<dd>

<p>The simplified example in this post doesn&#8217;t do much in terms of locking down

the deployment pipeline. In real-world usage, you&#8217;d want to configure approval workflows, access controls (especially

on who can edit workflows), and a number of other checks to secure your pipeline.</p>

</dd>

</dl>

</div>

</td>

</tr>

</table>

</div>

<div class="paragraph">

<p>Let&#8217;s first create a workflow for the <code>plan</code> portion. Create a new file called <em>.github/workflows/tofu-plan.yml</em> with

the contents shown in <a href="06.html#tofu_plan_workflow">Example 105</a>:</p>

</div>

<div id="tofu_plan_workflow" class="exampleblock">

<div class="title">Example 105. The workflow to run <code>tofu plan</code> (<em>.github/workflows/tofu-plan.yml</em>)</div>

<div class="content">

<div class="listingblock">

<div class="content">

<pre class="CodeRay highlight"><code data-lang="yaml"><span style="color:#606">name</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">Tofu Plan</span></span>



<span style="color:#606">on</span>:

  <span style="color:#606">pull_request</span>: # <b class="conum">(1)</b>

    <span style="color:#606">branches</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">[&quot;main&quot;]</span></span>

    <span style="color:#606">paths</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">[&quot;ch5/tofu/live/lambda-sample/**&quot;]</span></span>



<span style="color:#606">jobs</span>:

  <span style="color:#606">plan</span>:

    <span style="color:#606">name</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Tofu Plan</span><span style="color:#710">&quot;</span></span>

    <span style="color:#606">runs-on</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">ubuntu-latest</span></span>

    <span style="color:#606">permissions</span>:

      <span style="color:#606">pull-requests</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">write </span></span># <b class="conum">(2)</b>

      <span style="color:#606">id-token</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">write</span></span>

      <span style="color:#606">contents</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">read</span></span>

    <span style="color:#606">steps</span>:

      - <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">uses: actions/checkout@v2</span></span>



      - <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">uses: aws-actions/configure-aws-credentials@v3</span></span>

        <span style="color:#606">with</span>:

          <span style="color:#777"># TODO: fill in your IAM role ARN!</span>

          <span style="color:#606">role-to-assume</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">arn:aws:iam::111111111111:role/lambda-sample-plan </span></span># <b class="conum">(3)</b>

          <span style="color:#606">role-session-name</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">plan-${{ github.run_number }}-${{ github.actor }}</span></span>

          <span style="color:#606">aws-region</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">us-east-2</span></span>



      - <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">uses: opentofu/setup-opentofu@v1</span></span>



      - <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">name: tofu plan </span></span># <b class="conum">(4)</b>

        <span style="color:#606">id</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">plan</span></span>

        <span style="color:#606">working-directory</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">ch5/tofu/live/lambda-sample</span></span>

        <span style="color:#606">run</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">|</span><span style="color:#D20">

          tofu init -no-color -input=false

          tofu plan -no-color -input=false -lock=false</span></span>



      - <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">uses: peter-evans/create-or-update-comment@v4 </span></span># <b class="conum">(5)</b>

        <span style="color:#606">if</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">always()</span></span>

        <span style="color:#606">env</span>:

          <span style="color:#606">RESULT_EMOJI</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">${{ steps.plan.outcome == 'success' &amp;&amp; '' || '' }}</span></span>

        <span style="color:#606">with</span>:

          <span style="color:#606">issue-number</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">${{ github.event.pull_request.number }}</span></span>

          <span style="color:#606">body</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">|</span><span style="color:#D20">

            ## ${{ env.RESULT_EMOJI }} `tofu plan` output

            ```${{ steps.plan.outputs.stdout }}```</span></span></code></pre>

</div>

</div>

</div>

</div>

<div class="paragraph">

<p>This workflow has a few things you haven&#8217;t seen before:</p>

</div>

<div class="colist arabic">

<ol>

<li>

<p>Instead of running on push, this workflow runs on pull requests. More specifically, only on pull requests against

the <code>main</code> branch that have modifications to the <em>ch5/tofu/live/lambda-sample</em> folder. In a real-world pipeline,

you may want to expand this to all modules in the <em>tofu</em> folder: e.g., <em>ch5/tofu/live/**</em>.</p>

</li>

<li>

<p>Add the <code>pull-request: write</code> permission so in (5), the workflow can post a comment on your pull request.</p>

</li>

<li>

<p>Assume the <code>plan</code> IAM role. Make sure to fill in your own IAM role ARN here from the <code>lambda_deploy_plan_role_arn</code>

output variable you got in the last section.</p>

</li>

<li>

<p>Run <code>tofu init</code> and <code>tofu plan</code>, passing a few flags to ensure the commands run well in a CI environment: i.e.,

disable terminal colors and interactive prompts. There&#8217;s also a flag to disable locking, as you don&#8217;t need that

for <code>plan</code>.</p>

</li>

<li>

<p>Use an open source workflow to post a comment on the pull request that contains the <code>plan</code> output. The comment is

formatted in Markdown, which GitHub natively supports, and includes not only the <code>plan</code> output, but also a

 or  emoji to help you see at a glance if the <code>plan</code> command ran successfully or exited with an error,

respectively. This allows your team members to review the code and <code>plan</code> output all in one place.</p>

</li>

</ol>

</div>

<div class="paragraph">

<p>Next, create a workflow for the <code>apply</code> portion in a new file called _.github/workflows/tofu-apply.yml, with the

contents shown in <a href="06.html#tofu_apply_workflow">Example 106</a>:</p>

</div>

<div id="tofu_apply_workflow" class="exampleblock">

<div class="title">Example 106. The workflow to run <code>tofu apply</code> (<em>.github/workflows/tofu-apply.yml</em>)</div>

<div class="content">

<div class="listingblock">

<div class="content">

<pre class="CodeRay highlight"><code data-lang="yaml"><span style="color:#606">name</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">Tofu Apply</span></span>

<span style="color:#606">on</span>:

  <span style="color:#606">push</span>: # <b class="conum">(1)</b>

    <span style="color:#606">branches</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">[&quot;main&quot;]</span></span>

    <span style="color:#606">paths</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">[&quot;ch5/tofu/live/lambda-sample/**&quot;]</span></span>

<span style="color:#606">jobs</span>:

  <span style="color:#606">apply</span>:

    <span style="color:#606">name</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Tofu Apply</span><span style="color:#710">&quot;</span></span>

    <span style="color:#606">runs-on</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">ubuntu-latest</span></span>

    <span style="color:#606">permissions</span>:

      <span style="color:#606">pull-requests</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">write</span></span>

      <span style="color:#606">id-token</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">write</span></span>

      <span style="color:#606">contents</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">read</span></span>

    <span style="color:#606">steps</span>:

      - <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">uses: actions/checkout@v2</span></span>



      - <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">uses: aws-actions/configure-aws-credentials@v3</span></span>

        <span style="color:#606">with</span>:

          <span style="color:#777"># TODO: fill in your IAM role ARN!</span>

          <span style="color:#606">role-to-assume</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">arn:aws:iam::111111111111:role/lambda-sample-apply </span></span># <b class="conum">(2)</b>

          <span style="color:#606">role-session-name</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">apply-${{ github.run_number }}-${{ github.actor }}</span></span>

          <span style="color:#606">aws-region</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">us-east-2</span></span>



      - <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">uses: opentofu/setup-opentofu@v1</span></span>



      - <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">name: tofu apply </span></span># <b class="conum">(3)</b>

        <span style="color:#606">id</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">apply</span></span>

        <span style="color:#606">working-directory</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">ch5/tofu/live/lambda-sample</span></span>

        <span style="color:#606">run</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">|</span><span style="color:#D20">

          tofu init -no-color -input=false

          tofu apply -no-color -input=false -lock-timeout=60m -auto-approve</span></span>



      - <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">uses: jwalton/gh-find-current-pr@master </span></span># <b class="conum">(4)</b>

        <span style="color:#606">id</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">find_pr</span></span>

        <span style="color:#606">with</span>:

          <span style="color:#606">state</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">all</span></span>



      - <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">uses: peter-evans/create-or-update-comment@v4 </span></span># <b class="conum">(5)</b>

        <span style="color:#606">if</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">steps.find_pr.outputs.number</span></span>

        <span style="color:#606">env</span>:

          <span style="color:#606">RESULT_EMOJI</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">${{ steps.apply.outcome == 'success' &amp;&amp; '' || '' }}</span></span>

        <span style="color:#606">with</span>:

          <span style="color:#606">issue-number</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">${{ steps.find_pr.outputs.number }}</span></span>

          <span style="color:#606">body</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">|</span><span style="color:#D20">

            ## ${{ env.RESULT_EMOJI }} `tofu apply` output

            ```${{ steps.apply.outputs.stdout }}```</span></span></code></pre>

</div>

</div>

</div>

</div>

<div class="paragraph">

<p>This workflow is similar the one for <code>plan</code>, but with a few key differences:</p>

</div>

<div class="colist arabic">

<ol>

<li>

<p>Run only on pushes to the <code>main</code> branch that have modifications to the <em>ch5/tofu/live/lambda-sample</em> folder.</p>

</li>

<li>

<p>Assume the <code>apply</code> IAM role. Make sure to fill in your own IAM role ARN here from the <code>lambda_deploy_apply_role_arn</code>

output variable you got in the last section.</p>

</li>

<li>

<p>Run <code>tofu init</code> and <code>tofu apply</code>, again passing a few flags to ensure the commands run well in a CI environment.

Note also the use of the <code>-lock-timeout=60m</code> to ensure this command will wait up to 60 minutes if someone else has

a lock (e.g., a concurrent <code>apply</code> being run by a previous merge).</p>

</li>

<li>

<p>If this push came from a pull request, use an open source GitHub Action to find the ID of that pull request so that

you can add the output of <code>apply</code> as a comment in (5).</p>

</li>

<li>

<p>If the previous step found a pull request ID, post a comment to the pull request with the <code>apply</code> output. Again,

this includes the  or  emoji to quickly let you know if <code>apply</code> succeeded, as well as the log output from

<code>apply</code> in case you need to debug a problem.</p>

</li>

</ol>

</div>

<div class="paragraph">

<p>Commit these new workflow files directly to the <code>main</code> branch and then push them to GitHub:</p>

</div>

<div class="listingblock">

<div class="content">

<pre>$ git add .github/workflows

$ git commit -m "Add plan and apply workflows"

$ git push origin main</pre>

</div>

</div>

<div class="paragraph">

<p>Now, let&#8217;s give this deployment pipeline a shot. First, create a new branch called <code>deployment-pipeline-test</code>:</p>

</div>

<div class="listingblock">

<div class="content">

<pre>$ git checkout -b deployment-pipeline-test</pre>

</div>

</div>

<div class="paragraph">

<p>Make a change to the <code>lambda-sample</code> module, such as changing the text it returns, as shown in

<a href="06.html#lambda_module_update_response">Example 107</a>:</p>

</div>

<div id="lambda_module_update_response" class="exampleblock">

<div class="title">Example 107. Update the Lambda function response text (<em>ch5/tofu/live/lambda-sample/src/index.js</em>)</div>

<div class="content">

<div class="listingblock">

<div class="content">

<pre class="CodeRay highlight"><code data-lang="javascript">exports.handler = (event, context, callback) =&gt; {

  callback(<span style="color:#069">null</span>, {<span style="color:#606">statusCode</span>: <span style="color:#00D">200</span>, <span style="color:#606">body</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Fundamentals of DevOps!</span><span style="color:#710">&quot;</span></span>});

};</code></pre>

</div>

</div>

</div>

</div>

<div class="paragraph">

<p>And make sure to similarly update the assertion in the automated test in <em>deploy.tftest.hcl</em>, as shown in

<a href="06.html#lambda_module_update_test">Example 108</a>:</p>

</div>

<div id="lambda_module_update_test" class="exampleblock">

<div class="title">Example 108. Update the Lambda module tests (<em>ch5/tofu/live/lambda-sample/deploy.tftest.hcl</em>)</div>

<div class="content">

<div class="listingblock">

<div class="content">

<pre class="CodeRay highlight"><code data-lang="terraform">  assert {

    condition     = data.http.test_endpoint.response_body == &quot;Fundamentals of DevOps!&quot;

    error_message = &quot;Website responded with body ${data.http.test_endpoint.response_body}&quot;

  }</code></pre>

</div>

</div>

</div>

</div>

<div class="paragraph">

<p>Commit both of these changes, push them to the <code>deployment-pipeline-test</code> branch, open a pull request, and you should see

a page that looks like <a href="06.html#github_pr_deployment_pipeline_running">Figure 58</a>:</p>

</div>

<div id="github_pr_deployment_pipeline_running" class="imageblock">

<div class="content">

<img src="images/ch5/gh-deployment-pipeline-running.png" alt="The deployment pipeline running in a GitHub PR">

</div>

<div class="title">Figure 58. The deployment pipeline running in a GitHub PR</div>

</div>

<div class="paragraph">

<p>You should see four things running in your pipeline:</p>

</div>

<div class="ulist">

<ul>

<li>

<p>Automated tests for the sample app.</p>

</li>

<li>

<p>Terrascan for your infrastructure code.</p>

</li>

<li>

<p>Tofu <code>test</code> for your infrastructure code.</p>

</li>

<li>

<p><code>tofu plan</code> on the <code>lambda-sample</code> module.</p>

</li>

</ul>

</div>

<div class="paragraph">

<p>When everything has finished, the PR should automatically be updated with a comment that shows the <code>plan</code> output, as

shown in <a href="06.html#github_pr_deployment_pipeline_plan_comment">Figure 59</a>:</p>

</div>

<div id="github_pr_deployment_pipeline_plan_comment" class="imageblock">

<div class="content">

<img src="images/ch5/gh-deployment-pipeline-plan-output.png" alt="After opening the PR, the deployment pipeline will add a comment with the plan output">

</div>

<div class="title">Figure 59. After opening the PR, the deployment pipeline will add a comment with the <code>plan</code> output</div>

</div>

<div class="paragraph">

<p>Now you can review the code changes and <code>plan</code> output, and if everything looks good, merge the PR. This will kick off

the <code>apply</code> workflow, and after a minute or two, it should post a comment with the <code>apply</code> output, as shown in

<a href="06.html#github_pr_deployment_pipeline_apply_comment">Figure 60</a>:</p>

</div>

<div id="github_pr_deployment_pipeline_apply_comment" class="imageblock">

<div class="content">

<img src="images/ch5/gh-deployment-pipeline-apply-output.png" alt="After merging the PR, the deployment pipeline will add a comment with the apply output">

</div>

<div class="title">Figure 60. After merging the PR, the deployment pipeline will add a comment with the <code>apply</code> output</div>

</div>

<div class="paragraph">

<p>And there you go, you now have a basic deployment pipeline in place for your <code>lambda-sample</code> module! It runs tests, it runs

<code>plan</code>, and it runs <code>apply</code>.</p>

</div>

<div class="admonitionblock tip">

<table>

<tr>

<td class="icon">

<div class="title">Tip</div>

</td>

<td class="content">

<div class="title">Get your hands dirty</div>

<div class="paragraph">

<p>Here are a few exercises you can try at home to get a better feel for deployment pipelines:</p>

</div>

<div class="ulist">

<ul>

<li>

<p>Update the pipeline to automatically detect changes in an <em>any</em> folder with OpenTofu code (rather than only the

<em>lambda-sample</em> folder), and to automatically run <code>plan</code> and <code>apply</code> in each one. The open source

<a href="https://github.com/marketplace/actions/changed-files">changed-files action</a> can be helpful here.</p>

</li>

<li>

<p>If a pull request updates multiple folders with OpenTofu code, have the pipeline run <code>plan</code> and <code>apply</code> across

multiple folders concurrently by using a

<a href="https://docs.github.com/en/actions/using-jobs/using-a-matrix-for-your-jobs">matrix strategy</a>.</p>

</li>

</ul>

</div>

</td>

</tr>

</table>

</div>

</div>

<div class="sect4">

<h4 id="_deployment_pipeline_best_practices">Deployment pipeline best practices</h4>

<div class="paragraph">

<p>Now that you&#8217;ve seen the basics of deployment pipelines, and an example of how to implement one, let&#8217;s go through the

best practices for deployment pipelines:</p>

</div>

<div class="dlist">

<dl>

<dt class="hdlist1">Automate all the steps that can be automated</dt>

<dd>

<p>Every deployment pipeline includes steps that <em>must</em> be done by humans, such as writing code, reviewing code, and

perhaps manual testing and verification. All the other steps should be completely automated. Remember, it&#8217;s only

continuous delivery if it is fast, reliable, and sustainable. These three things are precisely where computers excel

over humans: whereas humans are slow at performing a bunch of steps, computers can run automated processes extremely

quickly; whereas humans make mistakes all the time while running manual processes, computers carry out automated

processes in a way that is predictable and repeatable; and whereas humans can get frustrated from repeating the same

steps over and over again (especially if those steps sometimes cause an outage), computers never get tired or

stressed.</p>

</dd>

<dt class="hdlist1">Deploy only from a deployment server</dt>

<dd>

<p>Not only should most of your deployment pipeline be automated, but in most cases, all of that automation should only

run on a dedicated deployment server and <em>not</em> any developer&#8217;s computer. In most cases, the deployment server is

your CI server (e.g., GitHub Actions, GitLab, Jenkins), but for some types of pipelines, you may have separate,

dedicated deployment tools (e.g., ArgoCD in a Kubernetes Cluster, HashiCorp Cloud Platform, Atlantis, etc.). Here&#8217;s

why:</p>

<div class="dlist">

<dl>

<dt class="hdlist1">Full automation</dt>

<dd>

<p>One of the benefits of forcing the deployment pipeline to run entirely in a deployment server is

that it forces you to fully automate everything that can be automated. There is a surprisingly big gap between a

pipeline that is <em>mostly</em> automated, but still requires a few manual steps here and there, and one that is <em>fully</em>

automated: if your pipeline relies on even a few manual steps, it can <em>dramatically</em> reduce the effectiveness of your

ability to deliver software.</p>

<div class="paragraph">

<p>Something magical happens when you get to full automation: it&#8217;s only when the whole pipeline runs from pushing a single

button, that you get a CD pipeline that is fast, reliable, and sustainable; that you have environments that are truly

reproducible; that all the steps are fully captured as code; that you can achieve world-class results like the

companies mentioned in <a href="index.html#world_class_delivery">What world-class software delivery looks like</a>, who are able to deploy thousands of times per day.</p>

</div>

</dd>

<dt class="hdlist1">Repeatability</dt>

<dd>

<p>If developers run deployments from their own computers, you&#8217;ll run into problems due to

differences in how their computers are configured: for example, different operating systems, different dependency

versions (e.g., different versions of OpenTofu or Node.js installed locally), different configurations, and

differences in what&#8217;s actually being deployed (e.g., the developer accidentally deploys a change that wasn&#8217;t

committed to version control). You can eliminate all of these issues by deploying everything from a dedicated

deployment server that provides a consistent, repeatable environment.</p>

</dd>

<dt class="hdlist1">Permissions management</dt>

<dd>

<p>Instead of giving developers permissions to deploy, you can give solely the deployment

server those permissions (especially for the production environment). It&#8217;s easier to enforce good security

practices for a single server than it is to do for numerous developers with production access.</p>

</dd>

</dl>

</div>

</dd>

<dt class="hdlist1">Protect the deployment server</dt>

<dd>

<p>To be able to do automated deployments from a server, you have to give the server access to sensitive permissions,

such as AWS credentials. In fact, to deploy arbitrary infrastructure changese.g., to be able to run <code>tofu apply</code> on

arbitrary OpenTofu modulesyou need arbitrary permissions, which is just a fun way of saying "admin permissions". So

deployment servers are a terrifying combination of (a) access to powerful, sensitive permissions, (b) accessible to

every developer in your company, and (c) designed to execute arbitrary code. This is why deployment servers are

particularly tempting targets for malicious actors.<sup class="footnote">[<a id="_footnoteref_45" class="footnote" href="13-footnotes.html#_footnotedef_45" title="View footnote.">45</a>]</sup></p>

<div class="paragraph">

<p>Here are a few things you can do to protect your deployment server:</p>

</div>

<div class="dlist">

<dl>

<dt class="hdlist1">Lock down your deployment server</dt>

<dd>

<p>Make it accessible solely over HTTPs, require all users to be authenticated,

ensure all actions are logged, and so on. If possible, don&#8217;t even allow the deployment server to be accessed over the

public Internet: e.g., lock it down so you can only access it from your company&#8217;s offices or over a VPN connection.

You&#8217;ll learn more about networking in <a href="07.html#how_to_set_up_networking">Part 6</a> and security functionality such as HTTPS and

authentication in <a href="08.html#how_to_manage_auth_and_secrets">Part 7</a>.</p>

</dd>

<dt class="hdlist1">Lock down your version control system</dt>

<dd>

<p>Since deployment servers typically execute workflows and code in your version

control system, if an attacker can slip malicious code into one of your repos, they can bypass most other protections.

Therefore, it&#8217;s critical that you protect your VCS, as described in <a href="05.html#protect_your_code">Section 4.1.5.5</a>.</p>

</dd>

<dt class="hdlist1">Enforce an approval workflow</dt>

<dd>

<p>Configure your deployment pipeline to require that every deployment is approved by at

least one person other than the person who requested the deployment in the first place. This ensures that if one

developer account is compromised, you always have a second set of eyes to hopefully catch malicious code before it

can take effect.</p>

</dd>

<dt class="hdlist1">Limit permissions before approval/merge</dt>

<dd>

<p>A common workflow to have in an infrastructure deployment pipeline is to

run <code>plan</code> when you open a PR and to run <code>apply</code> after the PR has been approved and merged. One thing you have to be

careful about is that the permissions you grant to the <code>plan</code> and <code>apply</code> steps: the <code>plan</code> step should only have

access to read permissions; the <code>apply</code> step should have access to both read and write permissions. If you use the

same set of permissions for both, then a malicious actor could open a PR that immediately uses the write permissions

to make whatever changes they wantbypassing all approval workflows.</p>

</dd>

<dt class="hdlist1">Don&#8217;t give the deployment server long-lived credentials</dt>

<dd>

<p>Whenever possible, use automatically-managed, short-lived

credentials (e.g., OIDC) instead of manually-managed, long-lived credentials (e.g., machine user access keys). That

way, if a malicious actor does manage to get access to those credentials, there is a short time window during which

they can use them, and then they expire.</p>

</dd>

<dt class="hdlist1">Limit the permissions of each pipeline</dt>

<dd>

<p>Instead of a single deployment pipeline that deploys arbitrary

code, and therefore needs arbitrary (admin) permissions, create multiple pipelines, each of which is designed for

specific tasks. You might partition your pipelines based on the type of task (e.g., deploy Kubernetes apps,

databases, networking) or by team (e.g., search team, analytics team, networking team), and the idea is to grant each

pipeline a limited set of permissions it needs for that set of tasks. You can also restrict access to each pipeline

so only the developers who need to use it have access to it. This limits the damage an attacker can do from

compromising any single developer account or pipeline.</p>

</dd>

<dt class="hdlist1">Limit what the pipeline can do with its permissions</dt>

<dd>

<p>In addition to limiting the permissions you grant to

each pipeline, you can also limit what developers can do with those permissions. For example, you might not want

developers to be able to execute arbitrary code in pipelines that have access to powerful permissions, so you might

put in checks that developers can only run specific commands (e.g., <code>tofu apply</code>), on code from specific repos

(e.g., repos where your team keeps it&#8217;s OpenTofu modules), on specific branches (e.g., <code>main</code>), and in specific

folders (e.g., search team members can only make changes in the <em>search</em> folder). You should also lock down the

workflow definitions themselves, so only a trusted set of admins can update them, and only with PR approval from at

least one other admin.<sup class="footnote">[<a id="_footnoteref_46" class="footnote" href="13-footnotes.html#_footnotedef_46" title="View footnote.">46</a>]</sup></p>

</dd>

</dl>

</div>

</dd>

</dl>

</div>

</div>

</div>

</div>

<div class="sect2">

<h2 id="_conclusion_5">Conclusion</h2>

<div class="paragraph">

<p>In this blog post and the previous one, you made great strides in automating your entire SDLC through

the use of CI/CD, allowing your team to work and collaborate as per the 5 key takeaways from this chapter:</p>

</div>

<div class="ulist">

<ul>

<li>

<p>All developers merge all their work together on a regular basis: typically daily or multiple times per day.</p>

</li>

<li>

<p>Use a self-testing build after every commit to ensure your code is always in a working and deployable state.</p>

</li>

<li>

<p>Use branch by abstraction and feature toggles to make large-scale changes while still merging your work on a regular

basis.</p>

</li>

<li>

<p>Use machine user credentials or automatically-provisioned credentials to authenticate from a CI server or other

automations.</p>

</li>

<li>

<p>You can deploy to production at any time in a manner that is fast, reliable, and sustainable.</p>

</li>

</ul>

</div>

<div class="paragraph">

<p>Virtually every company that has a world-class software delivery process, as the ones you heard about in

<a href="index.html#world_class_delivery">What world-class software delivery looks like</a>, relies heavily on CI/CD to allow them to go fast. This is one of the surprising realizations

of real-world systems: <em>agility requires safety</em>. With cars, speed limits are determined not by the limits

of enginesmost cars can easily go over 100 mphbut by safety, where the safety mechanisms we have today, such as brakes,

bumpers, and seat belts, are just not sufficient to protect you at speeds significantly over 60 mph.</p>

</div>

<div class="paragraph">

<p>The same is true with software delivery: the limit of how fast you can build software is usually not determined by how

fast a developer can build new features, but by how quickly you can get those features to your users without causing

bugs, outages, security incidents, and other problems. That&#8217;s why CI/CD is all about putting safety mechanisms in

place, such as automated tests, code reviews, and feature toggles, so that you can release software faster <em>without</em>

putting your product and users at risk. The more you can limit the riskthe safer you can make it for developers to

release featuresthe faster you can go.</p>

</div>

<div class="paragraph">

<p>CI/CD considerably reduces risks, but there&#8217;s still more to do. One place where risks remain is with networking. So

far, everything you&#8217;ve deployedall the EC2 instances, EKS clusters, and so onhas been directly accessible over the

public Internet. This is convenient for learning and testing, but it means that any slight lapse in securitye.g.,

leaving a port open by accident in a firewall or running out-of-date software that has a vulnerabilitycan be

<em>immediately</em> exploited by malicious actors. And those malicious actors are out there, scanning for vulnerabilities, all

day, every day.</p>

</div>

<div class="paragraph">

<p>A proper networking setup can give you extra layers of protection, so you&#8217;re never just one mistake away from disaster.

This is the focus of the next blog post, <a href="07.html#how_to_set_up_networking">Part 6</a>, where you&#8217;ll learn about VPCs,

VPN, SSH, DNS, and more.</p>

</div>

</div>

</div>

</div>

</div>
<div id="footer">

<div id="footer-text">

Last updated 2024-05-20 14:12:46 -0400

</div>

</div>


    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

<script src="https://cdn.jsdelivr.net/npm/anchor-js/anchor.min.js"></script>
<script>
  anchors.add();
</script>

</body>

</html>